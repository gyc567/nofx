# P0认证系统修复 - 任务清单

## 📋 任务状态概览

**总任务数**: 5
**已完成**: 0
**进行中**: 1
**待开始**: 4

---

## ✅ 任务列表

### 任务 #1: 创建修复提案文档
- [x] 创建proposal.md
- [x] 创建specs/auth/spec.md
- [x] 创建tasks.md (本文件)
- [x] 提交提案到Git
- [ ] 代码审查并批准

**负责人**: Claude Code审计员
**开始时间**: 2025-11-22
**预计工时**: 0.5h
**实际工时**: 0.5h

---

### 任务 #2: 修复重复密码验证代码
- [ ] 定位重复代码位置 (server.go:1274-1427)
- [ ] 分析验证逻辑，确保合并后功能正确
- [ ] 删除第二次密码验证代码
- [ ] 代码注释说明修改原因
- [ ] 运行单元测试验证
- [ ] Go lint检查

**负责人**: 后端开发
**开始时间**: 待定
**预计工时**: 0.5h
**依赖**: 任务 #1 完成

**详细步骤**:
1. 打开 `api/server.go`
2. 找到 `handleRegister` 函数
3. 确认第一次验证 (1292-1300行)
4. 删除第二次验证 (1357-1365行)
5. 确保其他验证逻辑完整
6. 提交代码

---

### 任务 #3: 实施CORS白名单
- [ ] 添加环境变量配置结构
- [ ] 修改 `corsMiddleware` 函数
- [ ] 支持动态域名白名单
- [ ] 添加CORS配置验证
- [ ] 更新文档说明配置方式
- [ ] 测试预检请求处理
- [ ] 安全测试确认

**负责人**: 后端开发
**开始时间**: 待定
**预计工时**: 0.5h
**依赖**: 任务 #2 完成

**详细步骤**:
1. 修改 `api/server.go` 的 `corsMiddleware` 函数
2. 添加环境变量 `ALLOWED_ORIGINS` 支持
3. 实现origin检查逻辑
4. 保留Credentials支持
5. 配置开发环境域名
6. 测试:
   ```bash
   # 测试允许的域名
   curl -H "Origin: http://localhost:3000" -X OPTIONS http://localhost:8080/api/login

   # 测试不允许的域名
   curl -H "Origin: http://evil.com" -X OPTIONS http://localhost:8080/api/login
   ```

---

### 任务 #4: 修复AuthContext Token验证逻辑
- [ ] 分析当前token恢复逻辑
- [ ] 实现JWT过期时间检查
- [ ] 添加token格式验证
- [ ] 处理无效token清理
- [ ] 添加错误日志
- [ ] 前端测试验证
- [ ] TypeScript类型检查

**负责人**: 前端开发
**开始时间**: 待定
**预计工时**: 0.5h
**依赖**: 任务 #3 完成

**详细步骤**:
1. 打开 `web/src/contexts/AuthContext.tsx`
2. 修改 `useEffect` 中的token恢复逻辑
3. 添加JWT payload解析和过期检查
4. 处理异常情况 (格式错误、过期等)
5. 自动清理无效数据
6. 测试场景:
   - 有效token → 正常恢复
   - 过期token → 清理并重新登录
   - 格式错误 → 清理并重新登录
   - 无token → 保持未登录状态

---

### 任务 #5: 集成测试与部署
- [ ] 合并所有修复到主分支
- [ ] 执行完整回归测试
- [ ] 运行安全扫描
- [ ] 部署到测试环境
- [ ] 监控认证成功率
- [ ] 灰度发布到生产
- [ ] 完成部署确认

**负责人**: QA + DevOps
**开始时间**: 待定
**预计工时**: 1h
**依赖**: 任务 #2, #3, #4 完成

**测试清单**:
- [ ] 注册流程测试
- [ ] 登录流程测试
- [ ] 密码重置流程测试
- [ ] CORS配置测试
- [ ] Token验证测试
- [ ] 跨浏览器兼容性测试
- [ ] 移动端适配测试

**监控指标**:
- 认证成功率
- API响应时间
- 错误率
- 用户活跃度

---

## 📊 进度追踪

### 每日进度更新

| 日期 | 任务进度 | 完成率 | 阻塞项 |
|------|----------|--------|--------|
| 2025-11-22 | 任务 #1 完成 | 20% | 无 |

### 里程碑

- [ ] **M1: 代码修复完成** (所有任务 #2-4 完成)
  - 目标时间: 2025-11-22 12:00
  - 状态: 未开始

- [ ] **M2: 测试通过** (所有测试用例通过)
  - 目标时间: 2025-11-22 15:00
  - 状态: 未开始

- [ ] **M3: 生产部署** (灰度发布完成)
  - 目标时间: 2025-11-22 18:00
  - 状态: 未开始

---

## 🚨 风险与阻塞

### 当前风险

| 风险项 | 影响 | 概率 | 应对措施 |
|--------|------|------|----------|
| 环境变量配置延迟 | 中 | 低 | 提前准备配置清单 |
| 测试发现问题 | 高 | 中 | 预留2h修复时间 |
| 部署窗口冲突 | 中 | 低 | 协调DevOps时间 |

### 解决方案

1. **配置问题**: 使用默认配置先行测试，后续更新
2. **测试失败**: 立即修复或回滚到稳定版本
3. **部署阻塞**: 准备回滚方案，确保快速恢复

---

## 📝 代码变更记录

### 文件变更列表

1. **api/server.go**
   - 修改函数: `handleRegister`
   - 修改函数: `corsMiddleware`
   - 总计行数: -15 行

2. **web/src/contexts/AuthContext.tsx**
   - 修改函数: `useEffect`
   - 新增函数: `validateToken`
   - 总计行数: +30 行

---

## ✅ 验收标准

### 必选项 (所有必须满足)

- [ ] 重复代码完全消除 (静态检查通过)
- [ ] CORS仅允许指定域名 (安全测试通过)
- [ ] 无效token不会导致伪登录 (功能测试通过)
- [ ] 现有功能不受影响 (回归测试100%通过)
- [ ] 编译无警告 (Go + TypeScript)

### 加分项 (提升质量)

- [ ] 添加单元测试覆盖率 > 80%
- [ ] 添加集成测试用例
- [ ] 性能基准测试 (认证耗时 < 100ms)
- [ ] 安全渗透测试通过
- [ ] 文档更新完整

---

## 📞 联系方式

**项目负责人**: 开发团队
**技术负责人**: [待指派]
**QA负责人**: [待指派]
**DevOps负责人**: [待指派]

**紧急联系**: Slack #p0-fix频道
**状态会议**: 每日 10:00 (15分钟)
**风险升级**: 立即通知技术负责人

---

## 🔗 相关链接

- [原始提案](./proposal.md)
- [技术规范](./specs/auth/spec.md)
- [Git分支](http://git.local/fix-p0-auth-issues)
- [CI/CD流水线](http://ci.local/pipeline/fix-p0-auth)
- [测试报告](http://test.local/report/fix-p0-auth)

---

**文档创建**: 2025-11-22 10:00
**最后更新**: 2025-11-22 10:00
**维护者**: Claude Code审计员
**审核状态**: 待审核
