# Monnaire Trading Agent OS - æ•°æ®åº“æ“ä½œæ‰‹å†Œ

## ğŸ“‹ ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ•°æ®åº“ç»“æ„](#æ•°æ®åº“ç»“æ„)
3. [SQLiteæ“ä½œæŒ‡å—](#sqliteæ“ä½œæŒ‡å—)
4. [Neon.techäº‘æ•°æ®åº“è¿ç§»æŒ‡å—](#neon-techäº‘æ•°æ®åº“è¿ç§»æŒ‡å—)
5. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
6. [å¤‡ä»½ä¸æ¢å¤](#å¤‡ä»½ä¸æ¢å¤)
7. [ç»´æŠ¤å‘½ä»¤å‚è€ƒ](#ç»´æŠ¤å‘½ä»¤å‚è€ƒ)

---

## æ¦‚è¿°

### æ•°æ®åº“ç³»ç»Ÿ
- **å¼€å‘ç¯å¢ƒ**: SQLite3 (æœ¬åœ°æ–‡ä»¶)
- **ç”Ÿäº§ç¯å¢ƒ**: PostgreSQL (Neon.techäº‘æ•°æ®åº“)
- **å½“å‰ç‰ˆæœ¬**: 2025-11-17
- **å…¼å®¹æ€§**: SQLite3 â†’ PostgreSQL 13+

### æ”¯æŒçš„äº¤æ˜“æ‰€
1. **Binance Futures** (CEX)
2. **Hyperliquid** (DEX)
3. **Aster DEX** (DEX)
4. **OKX Futures** (CEX) â† æœ€æ–°æ·»åŠ 

### æ”¯æŒçš„AIæ¨¡å‹
1. DeepSeek
2. Qwen

---

## æ•°æ®åº“ç»“æ„

### ä¸»è¦è¡¨ç»“æ„

#### 1. users - ç”¨æˆ·è¡¨
```sql
- id: TEXT PRIMARY KEY
- email: TEXT UNIQUE
- password_hash: TEXT
- is_admin: BOOLEAN
- created_at: TIMESTAMPTZ
```

#### 2. ai_models - AIæ¨¡å‹é…ç½®
```sql
- id: TEXT (å¤åˆä¸»é”®)
- user_id: TEXT (å¤åˆä¸»é”®)
- name: TEXT
- provider: TEXT
- enabled: BOOLEAN
- api_key: TEXT
```

#### 3. exchanges - äº¤æ˜“æ‰€é…ç½®
```sql
- id: TEXT (å¤åˆä¸»é”®)
- user_id: TEXT (å¤åˆä¸»é”®)
- name: TEXT
- type: TEXT ('cex' æˆ– 'dex')
- enabled: BOOLEAN
- api_key: TEXT
- secret_key: TEXT
- okx_passphrase: TEXT â† OKXç‰¹æœ‰å­—æ®µ
```

#### 4. traders - äº¤æ˜“å‘˜é…ç½®
```sql
- id: TEXT PRIMARY KEY
- user_id: TEXT
- ai_model_id: TEXT
- exchange_id: TEXT
- initial_balance: REAL
- is_running: BOOLEAN
```

#### 5. system_config - ç³»ç»Ÿé…ç½®
```sql
- key: TEXT PRIMARY KEY
- value: TEXT
```

---

## SQLiteæ“ä½œæŒ‡å—

### å‰ææ¡ä»¶
ç¡®ä¿å·²å®‰è£…SQLite3ï¼š
```bash
# macOS
brew install sqlite3

# Ubuntu/Debian
sudo apt-get install sqlite3

# Windows
# ä¸‹è½½ https://sqlite.org/download.html
```

### åŸºæœ¬æ“ä½œ

#### 1. è¿æ¥æ•°æ®åº“
```bash
sqlite3 config.db
```

#### 2. æŸ¥çœ‹è¡¨ç»“æ„
```sql
.schema
.schema exchanges
```

#### 3. æŸ¥çœ‹æ•°æ®
```sql
-- æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„äº¤æ˜“æ‰€
SELECT id, name, type FROM exchanges WHERE user_id = 'default';

-- æŸ¥çœ‹ç³»ç»Ÿé…ç½®
SELECT key, value FROM system_config;

-- æŸ¥çœ‹ç”¨æˆ·é…ç½®çš„äº¤æ˜“å‘˜
SELECT * FROM traders WHERE user_id = 'your_user_id';
```

#### 4. æ’å…¥æ•°æ®
```sql
-- æ’å…¥è‡ªå®šä¹‰äº¤æ˜“æ‰€ï¼ˆå¯é€‰ï¼‰
INSERT INTO exchanges (id, user_id, name, type, enabled)
VALUES ('custom_exchange', 'your_user_id', 'Custom Exchange', 'cex', 0);
```

#### 5. æ›´æ–°æ•°æ®
```sql
-- ä¿®å¤OKXç±»å‹é—®é¢˜
UPDATE exchanges SET type = 'cex' WHERE id = 'okx';

-- å¯ç”¨/ç¦ç”¨äº¤æ˜“æ‰€
UPDATE exchanges SET enabled = 1 WHERE id = 'binance';

-- æ›´æ–°ç³»ç»Ÿé…ç½®
UPDATE system_config SET value = '10' WHERE key = 'btc_eth_leverage';
```

#### 6. åˆ é™¤æ•°æ®
```sql
-- åˆ é™¤ç”¨æˆ·äº¤æ˜“å‘˜
DELETE FROM traders WHERE user_id = 'your_user_id';

-- æ¸…ç©ºç”¨æˆ·é…ç½®ï¼ˆæ…ç”¨ï¼ï¼‰
DELETE FROM ai_models WHERE user_id = 'your_user_id';
DELETE FROM exchanges WHERE user_id = 'your_user_id';
```

#### 7. é€€å‡ºSQLite
```sql
.quit
```

### å¸¸ç”¨æŸ¥è¯¢è„šæœ¬

#### æŸ¥çœ‹é…ç½®çŠ¶æ€
```sql
-- åˆ›å»ºæŸ¥è¯¢è„šæœ¬
cat > check_config.sql << 'EOF'
.mode column
.headers on

SELECT '=== AIæ¨¡å‹é…ç½® ===' as info;
SELECT id, name, provider, enabled FROM ai_models WHERE user_id = 'default';

SELECT '=== äº¤æ˜“æ‰€é…ç½® ===' as info;
SELECT id, name, type, enabled FROM exchanges WHERE user_id = 'default';

SELECT '=== äº¤æ˜“å‘˜æ•°é‡ ===' as info;
SELECT COUNT(*) as total_traders FROM traders;

SELECT '=== ç³»ç»Ÿé…ç½® ===' as info;
SELECT key, value FROM system_config ORDER BY key;
EOF

-- æ‰§è¡ŒæŸ¥è¯¢
sqlite3 config.db < check_config.sql
```

#### ä¿®å¤OKXé—®é¢˜
```sql
-- ä¸€é”®ä¿®å¤è„šæœ¬
cat > fix_okx.sql << 'EOF'
UPDATE exchanges SET type = 'cex' WHERE id = 'okx' AND user_id = 'default';

SELECT '=== éªŒè¯ä¿®å¤ç»“æœ ===' as info;
SELECT id, name, type FROM exchanges WHERE id = 'okx';

SELECT '=== æ‰€æœ‰äº¤æ˜“æ‰€ ===' as info;
SELECT id, name, type FROM exchanges WHERE user_id = 'default' ORDER BY id;
EOF

sqlite3 config.db < fix_okx.sql
```

---

## Neon.techäº‘æ•°æ®åº“è¿ç§»æŒ‡å—

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ

#### 1.1 æ³¨å†ŒNeon.techè´¦å·
1. è®¿é—® [neon.tech](https://neon.tech)
2. ä½¿ç”¨GitHub/Googleè´¦å·ç™»å½•
3. åˆ›å»ºå…è´¹è´¦å·ï¼ˆæ¯æœˆ500MBæ•°æ®åº“ï¼‰

#### 1.2 åˆ›å»ºæ•°æ®åº“é¡¹ç›®
1. ç‚¹å‡» "New Project"
2. é€‰æ‹©åŒºåŸŸï¼ˆæ¨èï¼šus-east-1 æˆ– ap-southeast-1ï¼‰
3. è®¾ç½®é¡¹ç›®åç§°ï¼šnofx-trading
4. è®¾ç½®æ•°æ®åº“åï¼šnofx
5. è®¾ç½®ç”¨æˆ·åå’Œå¯†ç ï¼ˆè®°å½•ä¸‹æ¥ï¼ï¼‰
6. ç‚¹å‡» "Create"

#### 1.3 è·å–è¿æ¥ä¿¡æ¯
é¡¹ç›®åˆ›å»ºå®Œæˆåï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
- **Host**: xxxxxx.neon.tech
- **Database**: nofx
- **User**: xxxxxx
- **Password**: xxxxxx
- **Port**: 5432

### ç¬¬äºŒæ­¥ï¼šå®‰è£…PostgreSQLå®¢æˆ·ç«¯

#### macOS
```bash
brew install postgresql
```

#### Ubuntu/Debian
```bash
sudo apt-get install postgresql-client-13
```

#### Windows
ä¸‹è½½ [PostgreSQL Windowså®‰è£…åŒ…](https://www.postgresql.org/download/windows/)

### ç¬¬ä¸‰æ­¥ï¼šè¿æ¥æµ‹è¯•
```bash
# æ›¿æ¢ä¸‹é¢çš„è¿æ¥ä¿¡æ¯ä¸ºæ‚¨çš„å®é™…ä¿¡æ¯
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME"

# ç¤ºä¾‹
psql "postgresql://abc123:def456@ep-xxx-xxx-xx-xx-xx.neon.tech:5432/nofx"
```

### ç¬¬å››æ­¥ï¼šæ‰§è¡Œè¿ç§»è„šæœ¬

#### æ–¹æ³•1ï¼šç›´æ¥æ‰§è¡Œï¼ˆæ¨èï¼‰
```bash
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME" -f migration.sql
```

#### æ–¹æ³•2ï¼šäº¤äº’å¼æ‰§è¡Œ
```bash
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME"
```

ç„¶åå¤åˆ¶ç²˜è´´ `migration.sql` ä¸­çš„å†…å®¹åˆ°ç»ˆç«¯ã€‚

### ç¬¬äº”æ­¥ï¼šéªŒè¯è¿ç§»ç»“æœ
```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨
\dt

-- æŸ¥çœ‹AIæ¨¡å‹
SELECT * FROM ai_models WHERE user_id = 'default';

-- æŸ¥çœ‹äº¤æ˜“æ‰€
SELECT * FROM exchanges WHERE user_id = 'default';

-- æŸ¥çœ‹ç³»ç»Ÿé…ç½®
SELECT * FROM system_config;
```

### ç¬¬å…­æ­¥ï¼šæ›´æ–°åº”ç”¨é…ç½®

#### æ›´æ–°.envæ–‡ä»¶ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
```bash
# åŸå§‹SQLiteé…ç½®
DATABASE_URL=sqlite:config.db

# æ›´æ–°ä¸ºPostgreSQLé…ç½®
DATABASE_URL=postgresql://USER:PASSWORD@HOST:PORT/DBNAME
```

#### æ›´æ–°ä»£ç é…ç½®
åœ¨Goä»£ç ä¸­ï¼Œæ‰¾åˆ°æ•°æ®åº“è¿æ¥é…ç½®ï¼š

```go
// main.go æˆ–ç›¸å…³æ–‡ä»¶
// åŸå§‹é…ç½®
// db, err := sql.Open("sqlite3", "config.db")

// æ›´æ–°ä¸º
db, err := sql.Open("postgres", os.Getenv("DATABASE_URL"))
```

#### ä½¿ç”¨ç¯å¢ƒå˜é‡
```bash
# .envæ–‡ä»¶
DATABASE_URL=postgresql://USER:PASSWORD@HOST:PORT/DBNAME
```

### ç¬¬ä¸ƒæ­¥ï¼šæ•°æ®è¿ç§»ï¼ˆä»SQLiteåˆ°PostgreSQLï¼‰

#### å¯¼å‡ºSQLiteæ•°æ®
```bash
# å¯¼å‡ºç”¨æˆ·é…ç½®
sqlite3 config.db ".dump ai_models" > ai_models.sql
sqlite3 config.db ".dump exchanges" > exchanges.sql
sqlite3 config.db ".dump traders" > traders.sql
sqlite3 config.db ".dump users" > users.sql
sqlite3 config.db ".dump system_config" > system_config.sql
```

#### æ¸…ç†å¯¼å‡ºæ•°æ®
éœ€è¦ç¼–è¾‘å¯¼å‡ºçš„SQLæ–‡ä»¶ï¼Œå°†SQLiteè¯­æ³•è½¬æ¢ä¸ºPostgreSQLï¼š

1. **BEGIN TRANSACTION;** â†’ åˆ é™¤
2. **COMMIT;** â†’ åˆ é™¤
3. **PRAGMA foreign_keys=OFF;** â†’ åˆ é™¤
4. **INSERT INTO** â†’ ä¿ç•™ï¼ˆå¤§éƒ¨åˆ†å…¼å®¹ï¼‰
5. **BOOLEANå€¼**: SQLiteä½¿ç”¨0/1ï¼ŒPostgreSQLä½¿ç”¨FALSE/TRUEï¼Œéœ€è¦æ›¿æ¢

æ‰¹é‡æ›¿æ¢ç¤ºä¾‹ï¼š
```bash
# Linux/macOS
sed -i 's/0\b/FALSE/g' *.sql
sed -i 's/1\b/TRUE/g' *.sql

# Windows (PowerShell)
(Get-Content *.sql) -replace '\b0\b','FALSE' | Set-Content *.sql
(Get-Content *.sql) -replace '\b1\b','TRUE' | Set-Content *.sql
```

#### å¯¼å…¥PostgreSQL
```bash
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME" -f system_config.sql
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME" -f users.sql
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME" -f ai_models.sql
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME" -f exchanges.sql
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME" -f traders.sql
```

### ç¬¬å…«æ­¥ï¼šæµ‹è¯•åº”ç”¨
```bash
# å¯åŠ¨åº”ç”¨
./nofx-backend

# æµ‹è¯•API
curl https://your-domain.com/api/health
curl https://your-domain.com/api/supported-exchanges
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: æ‰§è¡Œè¿ç§»è„šæœ¬æ—¶æç¤ºè¯­æ³•é”™è¯¯
**ç—‡çŠ¶**:
```
ERROR:  syntax error at or near "IF"
```

**è§£å†³**:
ç¡®ä¿ä½¿ç”¨çš„æ˜¯PostgreSQLå®¢æˆ·ç«¯ï¼š
```bash
which psql
psql --version
```

### Q2: OKXäº¤æ˜“æ‰€ä»ç„¶ä¸æ˜¾ç¤ºAPI Keyå­—æ®µ

**ç—‡çŠ¶**:
```
é€‰æ‹©OKX Futuresï¼Œé…ç½®æ¨¡æ€æ¡†åªæ˜¾ç¤ºPassphraseå­—æ®µ
```

**è§£å†³**:
æ£€æŸ¥æ•°æ®åº“ä¸­çš„OKXç±»å‹ï¼š
```sql
-- SQLite
sqlite3 config.db "SELECT id, type FROM exchanges WHERE id = 'okx';"

-- PostgreSQL
psql "CONNECTION_STRING" -c "SELECT id, type FROM exchanges WHERE id = 'okx';"
```

å¦‚æœtypeä¸æ˜¯'cex'ï¼Œæ‰§è¡Œä¿®å¤ï¼š
```sql
UPDATE exchanges SET type = 'cex' WHERE id = 'okx';
```

### Q3: æ•°æ®å¯¼å‡ºæ—¶å‡ºç°ç¼–ç é—®é¢˜

**ç—‡çŠ¶**:
```
Error: Could not convert to UTF-8
```

**è§£å†³**:
```bash
# è®¾ç½®å¯¼å‡ºç¼–ç 
sqlite3 -encoding UTF-8 config.db ".dump" > backup.sql
```

### Q4: PostgreSQLè¿æ¥è¢«æ‹’ç»

**ç—‡çŠ¶**:
```
psql: error: connection to server at "xxx", port 5432 failed
```

**è§£å†³**:
1. æ£€æŸ¥Neoné¡¹ç›®çŠ¶æ€ï¼ˆæ˜¯å¦æš‚åœï¼‰
2. æ£€æŸ¥IPç™½åå•ï¼ˆNeoné»˜è®¤å…è®¸æ‰€æœ‰IPï¼‰
3. æ£€æŸ¥è¿æ¥ä¿¡æ¯æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼š
```bash
telnet xxxx.neon.tech 5432
```

### Q5: è¿ç§»åè§¦å‘å™¨ä¸å·¥ä½œ

**ç—‡çŠ¶**:
```
updated_atå­—æ®µä¸è‡ªåŠ¨æ›´æ–°
```

**è§£å†³**:
é‡æ–°åˆ›å»ºè§¦å‘å™¨ï¼š
```sql
-- åˆ é™¤æ—§è§¦å‘å™¨
DROP TRIGGER IF EXISTS update_updated_at ON table_name;

-- é‡æ–°åˆ›å»º
CREATE TRIGGER update_table_name_updated_at
    BEFORE UPDATE ON table_name
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## å¤‡ä»½ä¸æ¢å¤

### SQLiteå¤‡ä»½

#### æ–¹æ³•1: å¤åˆ¶æ•°æ®åº“æ–‡ä»¶
```bash
# ç®€å•å¤åˆ¶
cp config.db config.db.backup.$(date +%Y%m%d_%H%M%S)

# å‹ç¼©å¤‡ä»½
gzip -c config.db > config.db.backup.$(date +%Y%m%d).gz
```

#### æ–¹æ³•2: å¯¼å‡ºSQL
```bash
sqlite3 config.db ".dump" > backup_$(date +%Y%m%d_%H%M%S).sql
```

### PostgreSQLå¤‡ä»½ï¼ˆNeonï¼‰

#### æ–¹æ³•1: ä½¿ç”¨pg_dump
```bash
pg_dump "postgresql://USER:PASSWORD@HOST:PORT/DBNAME" > backup.sql
```

#### æ–¹æ³•2: ä½¿ç”¨Neon Dashboard
1. ç™»å½• [Neonæ§åˆ¶å°](https://neon.tech)
2. é€‰æ‹©é¡¹ç›®
3. ç‚¹å‡» "Branches" â†’ é€‰æ‹©åˆ†æ”¯
4. ç‚¹å‡» "Restore"
5. é€‰æ‹©æ—¶é—´ç‚¹æˆ–åˆ›å»ºæ–°åˆ†æ”¯

### æ¢å¤æ•°æ®

#### æ¢å¤SQLite
```bash
# ä»SQLæ–‡ä»¶æ¢å¤
sqlite3 config.db < backup.sql

# ä»å‹ç¼©æ–‡ä»¶æ¢å¤
gunzip -c backup.sql.gz | sqlite3 config.db
```

#### æ¢å¤PostgreSQL
```bash
psql "postgresql://USER:PASSWORD@HOST:PORT/DBNAME" < backup.sql
```

---

## ç»´æŠ¤å‘½ä»¤å‚è€ƒ

### æ¸…ç†è¿‡æœŸæ•°æ®

#### SQLite
```sql
-- æ¸…ç†æ—§çš„ç™»å½•å°è¯•è®°å½•ï¼ˆä¿ç•™30å¤©ï¼‰
DELETE FROM login_attempts WHERE timestamp < datetime('now', '-30 days');

-- æ¸…ç†å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™90å¤©ï¼‰
DELETE FROM audit_logs WHERE created_at < datetime('now', '-90 days');
```

#### PostgreSQL
```sql
-- æ¸…ç†æ—§çš„ç™»å½•å°è¯•è®°å½•ï¼ˆä¿ç•™30å¤©ï¼‰
DELETE FROM login_attempts WHERE timestamp < NOW() - INTERVAL '30 days';

-- æ¸…ç†å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™90å¤©ï¼‰
DELETE FROM audit_logs WHERE created_at < NOW() - INTERVAL '90 days';
```

### æ€§èƒ½ä¼˜åŒ–

#### åˆ›å»ºç´¢å¼•
```sql
-- åˆ›å»ºå¸¸ç”¨æŸ¥è¯¢ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_traders_user_running ON traders(user_id, is_running);
CREATE INDEX IF NOT EXISTS idx_login_email_timestamp ON login_attempts(email, timestamp);
```

#### åˆ†æè¡¨ç»Ÿè®¡
```sql
-- PostgreSQL
ANALYZE;

-- SQLite
ANALYZE;
```

### ç›‘æ§æŸ¥è¯¢

#### æŸ¥çœ‹è¡¨å¤§å°
```sql
-- PostgreSQL
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE schemaname = 'public'
ORDER BY tablename, attname;

-- SQLite
SELECT name FROM sqlite_master WHERE type='index';
```

#### æŸ¥çœ‹æ´»åŠ¨è¿æ¥
```sql
-- PostgreSQL
SELECT * FROM pg_stat_activity WHERE state = 'active';
```

---

## æ”¯æŒä¸è”ç³»

### ç›¸å…³æ–‡æ¡£
- [OKX_FIX_INSTRUCTIONS.md](../OKX_FIX_INSTRUCTIONS.md) - OKXä¿®å¤æŒ‡å—
- [SQLITE_TO_NEON_MIGRATION_GUIDE.md](../SQLITE_TO_NEON_MIGRATION_GUIDE.md) - è¯¦ç»†è¿ç§»æŒ‡å—

### é—®é¢˜åé¦ˆ
å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. æ•°æ®åº“ç±»å‹ï¼ˆSQLite/PostgreSQLï¼‰
2. é”™è¯¯ä¿¡æ¯æˆªå›¾
3. æ‰§è¡Œçš„SQLå‘½ä»¤
4. æ•°æ®åº“ç‰ˆæœ¬ä¿¡æ¯

---

## æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2025-11-17 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒSQLiteå’ŒPostgreSQL |
| 2025-11-17 | v1.1 | æ·»åŠ OKXäº¤æ˜“æ‰€ä¿®å¤ï¼Œæ ‡å‡†åŒ–äº¤æ˜“æ‰€ç±»å‹ |
| 2025-11-17 | v1.2 | æ·»åŠ Neon.techè¿ç§»æŒ‡å— |

---

**æœ€åæ›´æ–°**: 2025-11-17
