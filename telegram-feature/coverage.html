
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>credits: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">nofx/api/credits/handler.go (45.5%)</option>
				
				<option value="file1">nofx/config/config.go (0.0%)</option>
				
				<option value="file2">nofx/config/credits.go (0.0%)</option>
				
				<option value="file3">nofx/config/credits_example.go (0.0%)</option>
				
				<option value="file4">nofx/config/database.go (0.0%)</option>
				
				<option value="file5">nofx/middleware/rate_limit.go (77.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">// Package credits 积分系统API处理层
// 设计哲学：清晰的输入输出、统一的错误处理、完整的参数验证
package credits

import (
        "fmt"
        "net/http"
        "nofx/config"
        "nofx/service/credits"
        "strconv"
        "strings"

        "github.com/gin-gonic/gin"
)

// Handler 积分API处理器
type Handler struct {
        service credits.Service
}

// NewHandler 创建积分API处理器
func NewHandler(service credits.Service) *Handler <span class="cov8" title="1">{
        return &amp;Handler{service: service}
}</span>

// RegisterRoutes 注册积分相关路由
func (h *Handler) RegisterRoutes(router *gin.RouterGroup) <span class="cov8" title="1">{
        // 公开的套餐查询接口（无需认证）
        router.GET("/credit-packages", h.HandleGetCreditPackages)
        router.GET("/credit-packages/:id", h.HandleGetCreditPackage)

        // 需要认证的用户积分接口
        protected := router.Group("/")
        protected.Use(authMiddleware())
        </span><span class="cov8" title="1">{
                protected.GET("/user/credits", h.HandleGetUserCredits)
                protected.GET("/user/credits/transactions", h.HandleGetUserTransactions)
                protected.GET("/user/credits/summary", h.HandleGetUserCreditSummary)
        }</span>

        // 管理员接口
        <span class="cov8" title="1">admin := router.Group("/admin/")
        admin.Use(authMiddleware())
        admin.Use(adminMiddleware())
        </span><span class="cov8" title="1">{
                // 套餐管理
                admin.POST("/credit-packages", h.HandleCreateCreditPackage)
                admin.PUT("/credit-packages/:id", h.HandleUpdateCreditPackage)
                admin.DELETE("/credit-packages/:id", h.HandleDeleteCreditPackage)

                // 用户积分管理
                admin.POST("/users/:id/credits/adjust", h.HandleAdjustUserCredits)
                admin.GET("/users/:id/credits", h.HandleGetUserCreditsByAdmin)
                admin.GET("/users/:id/credits/transactions", h.HandleGetUserTransactionsByAdmin)
        }</span>
}

// handleGetCreditPackages 获取积分套餐列表
// @Summary 获取所有启用的积分套餐
// @Description 获取系统中所有可用的积分套餐，按排序顺序返回
// @Tags 积分系统
// @Accept json
// @Produce json
// @Success 200 {object} map[string]interface{} "套餐列表"
// @Failure 500 {object} map[string]string "错误信息"
// @Router /api/v1/credit-packages [get]
func (h *Handler) HandleGetCreditPackages(c *gin.Context) <span class="cov8" title="1">{
        packages, err := h.service.GetActivePackages(c.Request.Context())
        if err != nil </span><span class="cov8" title="1">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "获取套餐列表失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov8" title="1">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "success",
                "data": gin.H{
                        "packages": packages,
                        "total": len(packages),
                },
        })</span>
}

// handleGetCreditPackage 获取指定积分套餐
// @Summary 获取积分套餐详情
// @Description 根据套餐ID获取详细信息
// @Tags 积分系统
// @Accept json
// @Produce json
// @Param id path string true "套餐ID"
// @Success 200 {object} map[string]interface{} "套餐详情"
// @Failure 404 {object} map[string]string "套餐不存在"
// @Failure 500 {object} map[string]string "服务器错误"
// @Router /api/v1/credit-packages/{id} [get]
func (h *Handler) HandleGetCreditPackage(c *gin.Context) <span class="cov8" title="1">{
        id := c.Param("id")
        if id == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "套餐ID不能为空",
                })
                return
        }</span>

        <span class="cov8" title="1">pkg, err := h.service.GetPackageByID(c.Request.Context(), id)
        if err != nil </span><span class="cov8" title="1">{
                if strings.Contains(err.Error(), "no rows") </span><span class="cov8" title="1">{
                        c.JSON(http.StatusNotFound, gin.H{
                                "error": "套餐不存在",
                        })
                        return
                }</span>
                <span class="cov0" title="0">c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "获取套餐失败",
                        "message": err.Error(),
                })
                return</span>
        }

        <span class="cov8" title="1">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "success",
                "data": gin.H{
                        "package": pkg,
                },
        })</span>
}

// handleGetUserCredits 获取用户积分余额
// @Summary 获取当前用户积分余额
// @Description 获取用户的可用积分、总积分和已用积分
// @Tags 积分系统
// @Accept json
// @Produce json
// @Success 200 {object} map[string]interface{} "积分信息"
// @Failure 401 {object} map[string]string "未认证"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/user/credits [get]
func (h *Handler) HandleGetUserCredits(c *gin.Context) <span class="cov8" title="1">{
        userID := getUserID(c)
        if userID == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusUnauthorized, gin.H{
                        "error": "用户未认证",
                })
                return
        }</span>

        <span class="cov8" title="1">credits, err := h.service.GetUserCredits(c.Request.Context(), userID)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "获取积分失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov8" title="1">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "success",
                "data": gin.H{
                        "available_credits": credits.AvailableCredits,
                        "total_credits": credits.TotalCredits,
                        "used_credits": credits.UsedCredits,
                },
        })</span>
}

// handleGetUserTransactions 获取用户积分流水
// @Summary 获取用户积分交易记录
// @Description 获取用户的积分收入和支出记录，支持分页
// @Tags 积分系统
// @Accept json
// @Produce json
// @Param page query int false "页码，默认为1"
// @Param limit query int false "每页数量，默认为20，最大100"
// @Success 200 {object} map[string]interface{} "流水列表"
// @Failure 400 {object} map[string]string "参数错误"
// @Failure 401 {object} map[string]string "未认证"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/user/credits/transactions [get]
func (h *Handler) HandleGetUserTransactions(c *gin.Context) <span class="cov8" title="1">{
        userID := getUserID(c)
        if userID == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusUnauthorized, gin.H{
                        "error": "用户未认证",
                })
                return
        }</span>

        // 解析分页参数
        <span class="cov8" title="1">page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))

        // 参数验证
        if page &lt; 1 </span><span class="cov0" title="0">{
                page = 1
        }</span>
        <span class="cov8" title="1">if limit &lt; 1 || limit &gt; 100 </span><span class="cov0" title="0">{
                limit = 20
        }</span>

        <span class="cov8" title="1">transactions, total, err := h.service.GetUserTransactions(c.Request.Context(), userID, page, limit)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "获取流水失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov8" title="1">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "success",
                "data": gin.H{
                        "transactions": transactions,
                        "total": total,
                        "page": page,
                        "limit": limit,
                        "total_pages": (total + limit - 1) / limit,
                },
        })</span>
}

// handleGetUserCreditSummary 获取用户积分摘要
// @Summary 获取用户积分统计摘要
// @Description 获取用户的积分统计信息，包括本月消费、充值等
// @Tags 积分系统
// @Accept json
// @Produce json
// @Success 200 {object} map[string]interface{} "积分摘要"
// @Failure 401 {object} map[string]string "未认证"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/user/credits/summary [get]
func (h *Handler) HandleGetUserCreditSummary(c *gin.Context) <span class="cov0" title="0">{
        userID := getUserID(c)
        if userID == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusUnauthorized, gin.H{
                        "error": "用户未认证",
                })
                return
        }</span>

        <span class="cov0" title="0">summary, err := h.service.GetUserCreditSummary(c.Request.Context(), userID)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "获取积分摘要失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "success",
                "data": summary,
        })</span>
}

// handleCreateCreditPackage 创建积分套餐（管理员）
// @Summary 创建积分套餐
// @Description 管理员创建新的积分套餐
// @Tags 积分系统-管理
// @Accept json
// @Produce json
// @Param package body CreditPackageRequest true "套餐信息"
// @Success 201 {object} map[string]interface{} "创建成功"
// @Failure 400 {object} map[string]string "参数错误"
// @Failure 403 {object} map[string]string "无权限"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/admin/credit-packages [post]
func (h *Handler) HandleCreateCreditPackage(c *gin.Context) <span class="cov8" title="1">{
        var req CreditPackageRequest
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov8" title="1">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "无效的请求格式",
                        "message": err.Error(),
                })
                return
        }</span>

        // 参数验证
        <span class="cov8" title="1">if err := validateCreditPackageRequest(&amp;req); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": err.Error(),
                })
                return
        }</span>

        <span class="cov8" title="1">pkg := &amp;config.CreditPackage{
                Name:          req.Name,
                NameEN:        req.NameEN,
                Description:   req.Description,
                PriceUSDT:     req.PriceUSDT,
                Credits:       req.Credits,
                BonusCredits:  req.BonusCredits,
                IsActive:      req.IsActive,
                IsRecommended: req.IsRecommended,
                SortOrder:     req.SortOrder,
        }

        if err := h.service.CreatePackage(c.Request.Context(), pkg); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "创建套餐失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov8" title="1">c.JSON(http.StatusCreated, gin.H{
                "code": 201,
                "message": "套餐创建成功",
                "data": gin.H{
                        "id": pkg.ID,
                },
        })</span>
}

// handleUpdateCreditPackage 更新积分套餐（管理员）
// @Summary 更新积分套餐
// @Description 管理员更新现有积分套餐
// @Tags 积分系统-管理
// @Accept json
// @Produce json
// @Param id path string true "套餐ID"
// @Param package body CreditPackageRequest true "套餐信息"
// @Success 200 {object} map[string]interface{} "更新成功"
// @Failure 400 {object} map[string]string "参数错误"
// @Failure 403 {object} map[string]string "无权限"
// @Failure 404 {object} map[string]string "套餐不存在"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/admin/credit-packages/{id} [put]
func (h *Handler) HandleUpdateCreditPackage(c *gin.Context) <span class="cov0" title="0">{
        id := c.Param("id")
        if id == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "套餐ID不能为空",
                })
                return
        }</span>

        <span class="cov0" title="0">var req CreditPackageRequest
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "无效的请求格式",
                        "message": err.Error(),
                })
                return
        }</span>

        // 参数验证
        <span class="cov0" title="0">if err := validateCreditPackageRequest(&amp;req); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": err.Error(),
                })
                return
        }</span>

        <span class="cov0" title="0">pkg := &amp;config.CreditPackage{
                ID:            id,
                Name:          req.Name,
                NameEN:        req.NameEN,
                Description:   req.Description,
                PriceUSDT:     req.PriceUSDT,
                Credits:       req.Credits,
                BonusCredits:  req.BonusCredits,
                IsActive:      req.IsActive,
                IsRecommended: req.IsRecommended,
                SortOrder:     req.SortOrder,
        }

        if err := h.service.UpdatePackage(c.Request.Context(), pkg); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "更新套餐失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "套餐更新成功",
        })</span>
}

// handleDeleteCreditPackage 删除积分套餐（管理员）
// @Summary 删除积分套餐
// @Description 管理员删除积分套餐（软删除）
// @Tags 积分系统-管理
// @Accept json
// @Produce json
// @Param id path string true "套餐ID"
// @Success 200 {object} map[string]interface{} "删除成功"
// @Failure 400 {object} map[string]string "参数错误"
// @Failure 403 {object} map[string]string "无权限"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/admin/credit-packages/{id} [delete]
func (h *Handler) HandleDeleteCreditPackage(c *gin.Context) <span class="cov0" title="0">{
        id := c.Param("id")
        if id == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "套餐ID不能为空",
                })
                return
        }</span>

        <span class="cov0" title="0">if err := h.service.DeletePackage(c.Request.Context(), id); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "删除套餐失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "套餐删除成功",
        })</span>
}

// handleAdjustUserCredits 管理员调整用户积分
// @Summary 管理员调整用户积分
// @Description 管理员手动调整用户积分余额，需要记录审计日志
// @Tags 积分系统-管理
// @Accept json
// @Produce json
// @Param id path string true "用户ID"
// @Param adjustment body AdjustCreditsRequest true "调整信息"
// @Success 200 {object} map[string]interface{} "调整成功"
// @Failure 400 {object} map[string]string "参数错误"
// @Failure 403 {object} map[string]string "无权限"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/admin/users/{id}/credits/adjust [post]
func (h *Handler) HandleAdjustUserCredits(c *gin.Context) <span class="cov8" title="1">{
        userID := c.Param("id")
        if userID == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "用户ID不能为空",
                })
                return
        }</span>

        <span class="cov8" title="1">adminID := getUserID(c)
        if adminID == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusUnauthorized, gin.H{
                        "error": "管理员未认证",
                })
                return
        }</span>

        <span class="cov8" title="1">var req AdjustCreditsRequest
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov8" title="1">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "无效的请求格式",
                        "message": err.Error(),
                })
                return
        }</span>

        // 参数验证
        <span class="cov8" title="1">if req.Amount == 0 </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "调整积分数量不能为0",
                })
                return
        }</span>

        <span class="cov8" title="1">if len(req.Reason) &lt; 2 || len(req.Reason) &gt; 200 </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "调整原因长度必须在2-200字符之间",
                })
                return
        }</span>

        // 获取客户端IP
        <span class="cov8" title="1">ipAddress := c.ClientIP()

        if err := h.service.AdjustUserCredits(c.Request.Context(), adminID, userID, req.Amount, req.Reason, ipAddress); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "调整积分失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov8" title="1">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "积分调整成功",
        })</span>
}

// handleGetUserCreditsByAdmin 管理员获取用户积分（管理员）
// @Summary 管理员获取用户积分
// @Description 管理员查看指定用户的积分信息
// @Tags 积分系统-管理
// @Accept json
// @Produce json
// @Param id path string true "用户ID"
// @Success 200 {object} map[string]interface{} "积分信息"
// @Failure 400 {object} map[string]string "参数错误"
// @Failure 403 {object} map[string]string "无权限"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/admin/users/{id}/credits [get]
func (h *Handler) HandleGetUserCreditsByAdmin(c *gin.Context) <span class="cov0" title="0">{
        userID := c.Param("id")
        if userID == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "用户ID不能为空",
                })
                return
        }</span>

        <span class="cov0" title="0">credits, err := h.service.GetUserCredits(c.Request.Context(), userID)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "获取用户积分失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "success",
                "data": gin.H{
                        "available_credits": credits.AvailableCredits,
                        "total_credits": credits.TotalCredits,
                        "used_credits": credits.UsedCredits,
                },
        })</span>
}

// handleGetUserTransactionsByAdmin 管理员获取用户积分流水（管理员）
// @Summary 管理员获取用户积分流水
// @Description 管理员查看指定用户的积分交易记录
// @Tags 积分系统-管理
// @Accept json
// @Produce json
// @Param id path string true "用户ID"
// @Param page query int false "页码，默认为1"
// @Param limit query int false "每页数量，默认为20，最大100"
// @Success 200 {object} map[string]interface{} "流水列表"
// @Failure 400 {object} map[string]string "参数错误"
// @Failure 403 {object} map[string]string "无权限"
// @Failure 500 {object} map[string]string "服务器错误"
// @Security BearerAuth
// @Router /api/v1/admin/users/{id}/credits/transactions [get]
func (h *Handler) HandleGetUserTransactionsByAdmin(c *gin.Context) <span class="cov0" title="0">{
        userID := c.Param("id")
        if userID == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "error": "用户ID不能为空",
                })
                return
        }</span>

        // 解析分页参数
        <span class="cov0" title="0">page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))

        // 参数验证
        if page &lt; 1 </span><span class="cov0" title="0">{
                page = 1
        }</span>
        <span class="cov0" title="0">if limit &lt; 1 || limit &gt; 100 </span><span class="cov0" title="0">{
                limit = 20
        }</span>

        <span class="cov0" title="0">transactions, total, err := h.service.GetUserTransactions(c.Request.Context(), userID, page, limit)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "error": "获取流水失败",
                        "message": err.Error(),
                })
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "message": "success",
                "data": gin.H{
                        "transactions": transactions,
                        "total": total,
                        "page": page,
                        "limit": limit,
                        "total_pages": (total + limit - 1) / limit,
                },
        })</span>
}

// 请求和响应结构体

// CreditPackageRequest 积分套餐请求
type CreditPackageRequest struct {
        Name          string  `json:"name" binding:"required"`
        NameEN        string  `json:"name_en"`
        Description   string  `json:"description"`
        PriceUSDT     float64 `json:"price_usdt" binding:"required,gt=0"`
        Credits       int     `json:"credits" binding:"required,gt=0"`
        BonusCredits  int     `json:"bonus_credits"`
        IsActive      bool    `json:"is_active"`
        IsRecommended bool    `json:"is_recommended"`
        SortOrder     int     `json:"sort_order"`
}

// AdjustCreditsRequest 调整积分请求
type AdjustCreditsRequest struct {
        Amount int    `json:"amount" binding:"required"`
        Reason string `json:"reason" binding:"required,min=2,max=200"`
}

// 工具函数

// validateCreditPackageRequest 验证积分套餐请求
func validateCreditPackageRequest(req *CreditPackageRequest) error <span class="cov8" title="1">{
        if req.Name == "" </span><span class="cov8" title="1">{
                return fmt.Errorf("套餐名称不能为空")
        }</span>
        <span class="cov8" title="1">if req.PriceUSDT &lt;= 0 </span><span class="cov8" title="1">{
                return fmt.Errorf("价格必须大于0")
        }</span>
        <span class="cov8" title="1">if req.Credits &lt;= 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("积分数量必须大于0")
        }</span>
        <span class="cov8" title="1">if req.BonusCredits &lt; 0 </span><span class="cov8" title="1">{
                return fmt.Errorf("赠送积分不能为负数")
        }</span>
        <span class="cov8" title="1">return nil</span>
}

// getUserID 从上下文中获取用户ID
func getUserID(c *gin.Context) string <span class="cov8" title="1">{
        // 从认证中间件获取用户ID
        if userID, exists := c.Get("userID"); exists </span><span class="cov8" title="1">{
                if id, ok := userID.(string); ok </span><span class="cov8" title="1">{
                        return id
                }</span>
        }
        <span class="cov8" title="1">return ""</span>
}

// extractUserIDFromToken 从token中提取用户ID（简化实现）
func extractUserIDFromToken(token string) string <span class="cov0" title="0">{
        // TODO: 实现实际的JWT token解析
        // 这里简化处理，直接返回token作为用户ID
        if token != "" &amp;&amp; len(token) &gt; 10 </span><span class="cov0" title="0">{
                return "user_" + token[:10]
        }</span>
        <span class="cov0" title="0">return ""</span>
}

// authMiddleware 认证中间件
func authMiddleware() gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                // 从请求头获取token
                authHeader := c.GetHeader("Authorization")
                if authHeader == "" </span><span class="cov8" title="1">{
                        c.JSON(http.StatusUnauthorized, gin.H{
                                "error": "缺少认证信息",
                        })
                        c.Abort()
                        return
                }</span>

                // 解析Bearer token
                <span class="cov8" title="1">tokenParts := strings.Split(authHeader, " ")
                if len(tokenParts) != 2 || tokenParts[0] != "Bearer" </span><span class="cov8" title="1">{
                        c.JSON(http.StatusUnauthorized, gin.H{
                                "error": "无效的认证格式",
                        })
                        c.Abort()
                        return
                }</span>

                <span class="cov0" title="0">token := tokenParts[1]

                // 验证token并获取用户ID
                // TODO: 实现token验证逻辑
                // userID, err := auth.ValidateToken(token)
                // 简化处理：从token中提取用户ID
                userID := extractUserIDFromToken(token)
                if userID == "" </span><span class="cov0" title="0">{
                        c.JSON(http.StatusUnauthorized, gin.H{
                                "error": "认证失败",
                                "message": "无效token",
                        })
                        c.Abort()
                        return
                }</span>

                // 将用户ID存入上下文
                <span class="cov0" title="0">c.Set("userID", userID)
                c.Next()</span>
        }
}

// adminMiddleware 管理员权限中间件
func adminMiddleware() gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                userID := getUserID(c)
                if userID == "" </span><span class="cov0" title="0">{
                        c.JSON(http.StatusUnauthorized, gin.H{
                                "error": "用户未认证",
                        })
                        c.Abort()
                        return
                }</span>

                // 检查用户是否为管理员
                // TODO: 实现管理员权限检查
                // 这里简化处理，实际应该查询数据库验证管理员身份
                <span class="cov0" title="0">isAdmin := checkAdminPermission(userID)
                if !isAdmin </span><span class="cov0" title="0">{
                        c.JSON(http.StatusForbidden, gin.H{
                                "error": "需要管理员权限",
                        })
                        c.Abort()
                        return
                }</span>

                <span class="cov0" title="0">c.Next()</span>
        }
}

// checkAdminPermission 检查管理员权限
func checkAdminPermission(userID string) bool <span class="cov0" title="0">{
        // TODO: 实现实际的管理员权限检查逻辑
        // 暂时返回true用于测试，实际应该查询数据库
        return true
}</pre>
		
		<pre class="file" id="file1" style="display: none">package config

import (
        "encoding/json"
        "fmt"
        "os"
        "time"
)

// TraderConfig 单个trader的配置
type TraderConfig struct {
        ID      string `json:"id"`
        Name    string `json:"name"`
        Enabled bool   `json:"enabled"`  // 是否启用该trader
        AIModel string `json:"ai_model"` // "qwen" or "deepseek"

        // 交易平台选择（二选一）
        Exchange string `json:"exchange"` // "binance" or "hyperliquid"

        // 币安配置
        BinanceAPIKey    string `json:"binance_api_key,omitempty"`
        BinanceSecretKey string `json:"binance_secret_key,omitempty"`

        // Hyperliquid配置
        HyperliquidPrivateKey string `json:"hyperliquid_private_key,omitempty"`
        HyperliquidWalletAddr string `json:"hyperliquid_wallet_addr,omitempty"`
        HyperliquidTestnet    bool   `json:"hyperliquid_testnet,omitempty"`

        // Aster配置
        AsterUser       string `json:"aster_user,omitempty"`        // Aster主钱包地址
        AsterSigner     string `json:"aster_signer,omitempty"`      // Aster API钱包地址
        AsterPrivateKey string `json:"aster_private_key,omitempty"` // Aster API钱包私钥

        // AI配置
        QwenKey     string `json:"qwen_key,omitempty"`
        DeepSeekKey string `json:"deepseek_key,omitempty"`

        // 自定义AI API配置（支持任何OpenAI格式的API）
        CustomAPIURL    string `json:"custom_api_url,omitempty"`
        CustomAPIKey    string `json:"custom_api_key,omitempty"`
        CustomModelName string `json:"custom_model_name,omitempty"`

        InitialBalance      float64 `json:"initial_balance"`
        ScanIntervalMinutes int     `json:"scan_interval_minutes"`
}

// LeverageConfig 杠杆配置
type LeverageConfig struct {
        BTCETHLeverage  int `json:"btc_eth_leverage"` // BTC和ETH的杠杆倍数（主账户建议5-50，子账户≤5）
        AltcoinLeverage int `json:"altcoin_leverage"` // 山寨币的杠杆倍数（主账户建议5-20，子账户≤5）
}

// Config 总配置
type Config struct {
        Traders            []TraderConfig `json:"traders"`
        UseDefaultCoins    bool           `json:"use_default_coins"` // 是否使用默认主流币种列表
        DefaultCoins       []string       `json:"default_coins"`     // 默认主流币种池
        APIServerPort      int            `json:"api_server_port"`
        MaxDailyLoss       float64        `json:"max_daily_loss"`
        MaxDrawdown        float64        `json:"max_drawdown"`
        StopTradingMinutes int            `json:"stop_trading_minutes"`
        Leverage           LeverageConfig `json:"leverage"` // 杠杆配置
}

// LoadConfig 从文件加载配置
func LoadConfig(filename string) (*Config, error) <span class="cov0" title="0">{
        data, err := os.ReadFile(filename)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("读取配置文件失败: %w", err)
        }</span>

        <span class="cov0" title="0">var config Config
        if err := json.Unmarshal(data, &amp;config); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("解析配置文件失败: %w", err)
        }</span>

        // 设置默认值：确保使用默认币种列表
        <span class="cov0" title="0">if !config.UseDefaultCoins </span><span class="cov0" title="0">{
                config.UseDefaultCoins = true
        }</span>

        // 设置默认币种池
        <span class="cov0" title="0">if len(config.DefaultCoins) == 0 </span><span class="cov0" title="0">{
                config.DefaultCoins = []string{
                        "BTCUSDT",
                        "ETHUSDT",
                        "SOLUSDT",
                        "BNBUSDT",
                        "XRPUSDT",
                        "DOGEUSDT",
                        "ADAUSDT",
                        "HYPEUSDT",
                }
        }</span>

        // 验证配置
        <span class="cov0" title="0">if err := config.Validate(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("配置验证失败: %w", err)
        }</span>

        <span class="cov0" title="0">return &amp;config, nil</span>
}

// Validate 验证配置有效性
func (c *Config) Validate() error <span class="cov0" title="0">{
        if len(c.Traders) == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("至少需要配置一个trader")
        }</span>

        <span class="cov0" title="0">traderIDs := make(map[string]bool)
        for i, trader := range c.Traders </span><span class="cov0" title="0">{
                if trader.ID == "" </span><span class="cov0" title="0">{
                        return fmt.Errorf("trader[%d]: ID不能为空", i)
                }</span>
                <span class="cov0" title="0">if traderIDs[trader.ID] </span><span class="cov0" title="0">{
                        return fmt.Errorf("trader[%d]: ID '%s' 重复", i, trader.ID)
                }</span>
                <span class="cov0" title="0">traderIDs[trader.ID] = true

                if trader.Name == "" </span><span class="cov0" title="0">{
                        return fmt.Errorf("trader[%d]: Name不能为空", i)
                }</span>
                <span class="cov0" title="0">if trader.AIModel != "qwen" &amp;&amp; trader.AIModel != "deepseek" &amp;&amp; trader.AIModel != "custom" </span><span class="cov0" title="0">{
                        return fmt.Errorf("trader[%d]: ai_model必须是 'qwen', 'deepseek' 或 'custom'", i)
                }</span>

                // 验证交易平台配置
                <span class="cov0" title="0">if trader.Exchange == "" </span><span class="cov0" title="0">{
                        trader.Exchange = "binance" // 默认使用币安
                }</span>
                <span class="cov0" title="0">if trader.Exchange != "binance" &amp;&amp; trader.Exchange != "hyperliquid" &amp;&amp; trader.Exchange != "aster" </span><span class="cov0" title="0">{
                        return fmt.Errorf("trader[%d]: exchange必须是 'binance', 'hyperliquid' 或 'aster'", i)
                }</span>

                // 根据平台验证对应的密钥
                <span class="cov0" title="0">if trader.Exchange == "binance" </span><span class="cov0" title="0">{
                        if trader.BinanceAPIKey == "" || trader.BinanceSecretKey == "" </span><span class="cov0" title="0">{
                                return fmt.Errorf("trader[%d]: 使用币安时必须配置binance_api_key和binance_secret_key", i)
                        }</span>
                } else<span class="cov0" title="0"> if trader.Exchange == "hyperliquid" </span><span class="cov0" title="0">{
                        if trader.HyperliquidPrivateKey == "" </span><span class="cov0" title="0">{
                                return fmt.Errorf("trader[%d]: 使用Hyperliquid时必须配置hyperliquid_private_key", i)
                        }</span>
                } else<span class="cov0" title="0"> if trader.Exchange == "aster" </span><span class="cov0" title="0">{
                        if trader.AsterUser == "" || trader.AsterSigner == "" || trader.AsterPrivateKey == "" </span><span class="cov0" title="0">{
                                return fmt.Errorf("trader[%d]: 使用Aster时必须配置aster_user, aster_signer和aster_private_key", i)
                        }</span>
                }

                <span class="cov0" title="0">if trader.AIModel == "qwen" &amp;&amp; trader.QwenKey == "" </span><span class="cov0" title="0">{
                        return fmt.Errorf("trader[%d]: 使用Qwen时必须配置qwen_key", i)
                }</span>
                <span class="cov0" title="0">if trader.AIModel == "deepseek" &amp;&amp; trader.DeepSeekKey == "" </span><span class="cov0" title="0">{
                        return fmt.Errorf("trader[%d]: 使用DeepSeek时必须配置deepseek_key", i)
                }</span>
                <span class="cov0" title="0">if trader.AIModel == "custom" </span><span class="cov0" title="0">{
                        if trader.CustomAPIURL == "" </span><span class="cov0" title="0">{
                                return fmt.Errorf("trader[%d]: 使用自定义API时必须配置custom_api_url", i)
                        }</span>
                        <span class="cov0" title="0">if trader.CustomAPIKey == "" </span><span class="cov0" title="0">{
                                return fmt.Errorf("trader[%d]: 使用自定义API时必须配置custom_api_key", i)
                        }</span>
                        <span class="cov0" title="0">if trader.CustomModelName == "" </span><span class="cov0" title="0">{
                                return fmt.Errorf("trader[%d]: 使用自定义API时必须配置custom_model_name", i)
                        }</span>
                }
                <span class="cov0" title="0">if trader.InitialBalance &lt;= 0 </span><span class="cov0" title="0">{
                        return fmt.Errorf("trader[%d]: initial_balance必须大于0", i)
                }</span>
                <span class="cov0" title="0">if trader.ScanIntervalMinutes &lt;= 0 </span><span class="cov0" title="0">{
                        trader.ScanIntervalMinutes = 3 // 默认3分钟
                }</span>
        }

        <span class="cov0" title="0">if c.APIServerPort &lt;= 0 </span><span class="cov0" title="0">{
                c.APIServerPort = 8080 // 默认8080端口
        }</span>

        // 设置杠杆默认值（适配币安子账户限制，最大5倍）
        <span class="cov0" title="0">if c.Leverage.BTCETHLeverage &lt;= 0 </span><span class="cov0" title="0">{
                c.Leverage.BTCETHLeverage = 5 // 默认5倍（安全值，适配子账户）
        }</span>
        <span class="cov0" title="0">if c.Leverage.BTCETHLeverage &gt; 5 </span><span class="cov0" title="0">{
                fmt.Printf("⚠️  警告: BTC/ETH杠杆设置为%dx，如果使用子账户可能会失败（子账户限制≤5x）\n", c.Leverage.BTCETHLeverage)
        }</span>
        <span class="cov0" title="0">if c.Leverage.AltcoinLeverage &lt;= 0 </span><span class="cov0" title="0">{
                c.Leverage.AltcoinLeverage = 5 // 默认5倍（安全值，适配子账户）
        }</span>
        <span class="cov0" title="0">if c.Leverage.AltcoinLeverage &gt; 5 </span><span class="cov0" title="0">{
                fmt.Printf("⚠️  警告: 山寨币杠杆设置为%dx，如果使用子账户可能会失败（子账户限制≤5x）\n", c.Leverage.AltcoinLeverage)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetScanInterval 获取扫描间隔
func (tc *TraderConfig) GetScanInterval() time.Duration <span class="cov0" title="0">{
        return time.Duration(tc.ScanIntervalMinutes) * time.Minute
}</span>
</pre>
		
		<pre class="file" id="file2" style="display: none">package config

import (
        "database/sql"
        "fmt"
        "log"
        "time"
)

// CreditPackage 积分套餐
type CreditPackage struct {
        ID            string    `json:"id"`
        Name          string    `json:"name"`
        NameEN        string    `json:"name_en"`
        Description   string    `json:"description"`
        PriceUSDT     float64   `json:"price_usdt"`
        Credits       int       `json:"credits"`
        BonusCredits  int       `json:"bonus_credits"`
        IsActive      bool      `json:"is_active"`
        IsRecommended bool      `json:"is_recommended"`
        SortOrder     int       `json:"sort_order"`
        CreatedAt     time.Time `json:"created_at"`
        UpdatedAt     time.Time `json:"updated_at"`
}

// UserCredits 用户积分账户
type UserCredits struct {
        ID               string    `json:"id"`
        UserID           string    `json:"user_id"`
        AvailableCredits int       `json:"available_credits"`
        TotalCredits     int       `json:"total_credits"`
        UsedCredits      int       `json:"used_credits"`
        CreatedAt        time.Time `json:"created_at"`
        UpdatedAt        time.Time `json:"updated_at"`
}

// CreditTransaction 积分流水
type CreditTransaction struct {
        ID            string    `json:"id"`
        UserID        string    `json:"user_id"`
        Type          string    `json:"type"` // credit/debit
        Amount        int       `json:"amount"`
        BalanceBefore int       `json:"balance_before"`
        BalanceAfter  int       `json:"balance_after"`
        Category      string    `json:"category"` // purchase/consume/gift/refund/admin
        Description   string    `json:"description"`
        ReferenceID   string    `json:"reference_id"`
        CreatedAt     time.Time `json:"created_at"`
}

// transactionResult 用于 withRetry 的返回结构
type transactionResult struct {
        Transactions []*CreditTransaction
        Total        int
}

// GetActivePackages 获取所有启用的套餐
func (d *Database) GetActivePackages() ([]*CreditPackage, error) <span class="cov0" title="0">{
        return withRetry(func() ([]*CreditPackage, error) </span><span class="cov0" title="0">{
                rows, err := d.query(`
                        SELECT id, name, name_en, description, price_usdt, credits, bonus_credits,
                                   is_active, is_recommended, sort_order, created_at, updated_at
                        FROM credit_packages
                        WHERE is_active = true
                        ORDER BY sort_order ASC, created_at ASC
                `)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">defer rows.Close()

                packages := make([]*CreditPackage, 0)
                for rows.Next() </span><span class="cov0" title="0">{
                        var pkg CreditPackage
                        err := rows.Scan(
                                &amp;pkg.ID, &amp;pkg.Name, &amp;pkg.NameEN, &amp;pkg.Description, &amp;pkg.PriceUSDT,
                                &amp;pkg.Credits, &amp;pkg.BonusCredits, &amp;pkg.IsActive, &amp;pkg.IsRecommended,
                                &amp;pkg.SortOrder, &amp;pkg.CreatedAt, &amp;pkg.UpdatedAt,
                        )
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov0" title="0">packages = append(packages, &amp;pkg)</span>
                }

                <span class="cov0" title="0">return packages, nil</span>
        })
}

// GetPackageByID 根据ID获取套餐
func (d *Database) GetPackageByID(id string) (*CreditPackage, error) <span class="cov0" title="0">{
        return withRetry(func() (*CreditPackage, error) </span><span class="cov0" title="0">{
                var pkg CreditPackage
                err := d.queryRow(`
                        SELECT id, name, name_en, description, price_usdt, credits, bonus_credits,
                                   is_active, is_recommended, sort_order, created_at, updated_at
                        FROM credit_packages WHERE id = $1
                `, id).Scan(
                        &amp;pkg.ID, &amp;pkg.Name, &amp;pkg.NameEN, &amp;pkg.Description, &amp;pkg.PriceUSDT,
                        &amp;pkg.Credits, &amp;pkg.BonusCredits, &amp;pkg.IsActive, &amp;pkg.IsRecommended,
                        &amp;pkg.SortOrder, &amp;pkg.CreatedAt, &amp;pkg.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">return &amp;pkg, nil</span>
        })
}

// GetUserCredits 获取用户积分（不存在则返回nil）
func (d *Database) GetUserCredits(userID string) (*UserCredits, error) <span class="cov0" title="0">{
        return withRetry(func() (*UserCredits, error) </span><span class="cov0" title="0">{
                var credits UserCredits
                err := d.queryRow(`
                        SELECT id, user_id, available_credits, total_credits, used_credits, created_at, updated_at
                        FROM user_credits WHERE user_id = $1
                `, userID).Scan(
                        &amp;credits.ID, &amp;credits.UserID, &amp;credits.AvailableCredits,
                        &amp;credits.TotalCredits, &amp;credits.UsedCredits, &amp;credits.CreatedAt, &amp;credits.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">return &amp;credits, nil</span>
        })
}

// GetOrCreateUserCredits 获取或创建用户积分账户 (使用 UPSERT)
func (d *Database) GetOrCreateUserCredits(userID string) (*UserCredits, error) <span class="cov0" title="0">{
        return withRetry(func() (*UserCredits, error) </span><span class="cov0" title="0">{
                var credits UserCredits
                var id string

                err := d.queryRow(`
                        INSERT INTO user_credits (id, user_id, available_credits, total_credits, used_credits, created_at, updated_at)
                        VALUES ($1, $2, 0, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
                        ON CONFLICT (user_id) DO UPDATE SET updated_at = CURRENT_TIMESTAMP
                        RETURNING id, user_id, available_credits, total_credits, used_credits, created_at, updated_at
                `, GenerateUUID(), userID).Scan(
                        &amp;id, &amp;credits.UserID, &amp;credits.AvailableCredits,
                        &amp;credits.TotalCredits, &amp;credits.UsedCredits, &amp;credits.CreatedAt, &amp;credits.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("创建用户积分账户失败: %w", err)
                }</span>

                <span class="cov0" title="0">credits.ID = id
                return &amp;credits, nil</span>
        })
}

// AddCredits 增加积分（事务，带流水记录）
func (d *Database) AddCredits(userID string, amount int, category, description, refID string) error <span class="cov0" title="0">{
        if amount &lt;= 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("增加积分数量必须大于0")
        }</span>

        <span class="cov0" title="0">_, err := withRetry(func() (bool, error) </span><span class="cov0" title="0">{
                // 开始事务
                tx, err := d.db.Begin()
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("开始事务失败: %w", err)
                }</span>
                <span class="cov0" title="0">defer tx.Rollback()

                // 获取当前积分并锁定行
                var availableCredits, totalCredits int
                var userCreditsID string
                err = tx.QueryRow(`
                        SELECT id, available_credits, total_credits
                        FROM user_credits
                        WHERE user_id = $1
                        FOR UPDATE
                `, userID).Scan(&amp;userCreditsID, &amp;availableCredits, &amp;totalCredits)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("锁定用户积分记录失败: %w", err)
                }</span>

                // 计算新的积分
                <span class="cov0" title="0">newAvailableCredits := availableCredits + amount
                newTotalCredits := totalCredits + amount

                // 更新用户积分
                _, err = tx.Exec(`
                        UPDATE user_credits
                        SET available_credits = $1, total_credits = $2, updated_at = CURRENT_TIMESTAMP
                        WHERE user_id = $3
                `, newAvailableCredits, newTotalCredits, userID)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("更新用户积分失败: %w", err)
                }</span>

                // 记录积分流水
                <span class="cov0" title="0">_, err = tx.Exec(`
                        INSERT INTO credit_transactions
                        (id, user_id, type, amount, balance_before, balance_after, category, description, reference_id, created_at)
                        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, CURRENT_TIMESTAMP)
                `, GenerateUUID(), userID, "credit", amount, availableCredits, newAvailableCredits,
                        category, description, refID)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("记录积分流水失败: %w", err)
                }</span>

                // 提交事务
                <span class="cov0" title="0">if err := tx.Commit(); err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("提交事务失败: %w", err)
                }</span>

                <span class="cov0" title="0">log.Printf("✅ 用户 %s 增加积分 %d (类别: %s)", userID, amount, category)
                return true, nil</span>
        })
        <span class="cov0" title="0">return err</span>
}

// DeductCredits 扣减积分（事务，带流水记录，检查余额）
func (d *Database) DeductCredits(userID string, amount int, category, description, refID string) error <span class="cov0" title="0">{
        if amount &lt;= 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("扣减积分数量必须大于0")
        }</span>

        <span class="cov0" title="0">_, err := withRetry(func() (bool, error) </span><span class="cov0" title="0">{
                // 开始事务
                tx, err := d.db.Begin()
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("开始事务失败: %w", err)
                }</span>
                <span class="cov0" title="0">defer tx.Rollback()

                // 获取当前积分并锁定行
                var availableCredits, totalCredits int
                var userCreditsID string
                err = tx.QueryRow(`
                        SELECT id, available_credits, total_credits
                        FROM user_credits
                        WHERE user_id = $1
                        FOR UPDATE
                `, userID).Scan(&amp;userCreditsID, &amp;availableCredits, &amp;totalCredits)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("锁定用户积分记录失败: %w", err)
                }</span>

                // 检查积分是否充足
                <span class="cov0" title="0">if availableCredits &lt; amount </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("积分不足: 当前可用积分 %d，需要 %d", availableCredits, amount)
                }</span>

                // 计算新的积分
                <span class="cov0" title="0">newAvailableCredits := availableCredits - amount
                newUsedCredits := totalCredits - availableCredits + amount // 实际使用的积分增加

                // 更新用户积分
                _, err = tx.Exec(`
                        UPDATE user_credits
                        SET available_credits = $1, used_credits = $2, updated_at = CURRENT_TIMESTAMP
                        WHERE user_id = $3
                `, newAvailableCredits, newUsedCredits, userID)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("更新用户积分失败: %w", err)
                }</span>

                // 记录积分流水
                <span class="cov0" title="0">_, err = tx.Exec(`
                        INSERT INTO credit_transactions
                        (id, user_id, type, amount, balance_before, balance_after, category, description, reference_id, created_at)
                        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, CURRENT_TIMESTAMP)
                `, GenerateUUID(), userID, "debit", amount, availableCredits, newAvailableCredits,
                        category, description, refID)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("记录积分流水失败: %w", err)
                }</span>

                // 提交事务
                <span class="cov0" title="0">if err := tx.Commit(); err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("提交事务失败: %w", err)
                }</span>

                <span class="cov0" title="0">log.Printf("✅ 用户 %s 扣减积分 %d (类别: %s)", userID, amount, category)
                return true, nil</span>
        })
        <span class="cov0" title="0">return err</span>
}

// HasEnoughCredits 检查积分是否充足
func (d *Database) HasEnoughCredits(userID string, amount int) bool <span class="cov0" title="0">{
        var availableCredits int
        err := d.queryRow(`
                SELECT available_credits FROM user_credits WHERE user_id = $1
        `, userID).Scan(&amp;availableCredits)

        if err != nil </span><span class="cov0" title="0">{
                log.Printf("⚠️ 获取用户积分失败: %v", err)
                return false
        }</span>

        <span class="cov0" title="0">return availableCredits &gt;= amount</span>
}

// GetUserTransactions 获取用户积分流水（分页）
func (d *Database) GetUserTransactions(userID string, page, limit int) ([]*CreditTransaction, int, error) <span class="cov0" title="0">{
        // 参数验证
        if limit &gt; 100 </span><span class="cov0" title="0">{
                limit = 100
        }</span>
        <span class="cov0" title="0">if page &lt; 1 </span><span class="cov0" title="0">{
                page = 1
        }</span>

        // 计算偏移量
        <span class="cov0" title="0">offset := (page - 1) * limit

        result, err := withRetry(func() (transactionResult, error) </span><span class="cov0" title="0">{
                // 获取总数
                var total int
                err := d.queryRow(`
                        SELECT COUNT(*) FROM credit_transactions WHERE user_id = $1
                `, userID).Scan(&amp;total)
                if err != nil </span><span class="cov0" title="0">{
                        return transactionResult{}, fmt.Errorf("获取积分流水总数失败: %w", err)
                }</span>

                // 获取积分流水
                <span class="cov0" title="0">rows, err := d.query(`
                        SELECT id, user_id, type, amount, balance_before, balance_after,
                                   category, description, reference_id, created_at
                        FROM credit_transactions
                        WHERE user_id = $1
                        ORDER BY created_at DESC
                        LIMIT $2 OFFSET $3
                `, userID, limit, offset)
                if err != nil </span><span class="cov0" title="0">{
                        return transactionResult{}, fmt.Errorf("查询积分流水失败: %w", err)
                }</span>
                <span class="cov0" title="0">defer rows.Close()

                transactions := make([]*CreditTransaction, 0)
                for rows.Next() </span><span class="cov0" title="0">{
                        var txn CreditTransaction
                        err := rows.Scan(
                                &amp;txn.ID, &amp;txn.UserID, &amp;txn.Type, &amp;txn.Amount,
                                &amp;txn.BalanceBefore, &amp;txn.BalanceAfter,
                                &amp;txn.Category, &amp;txn.Description, &amp;txn.ReferenceID, &amp;txn.CreatedAt,
                        )
                        if err != nil </span><span class="cov0" title="0">{
                                return transactionResult{}, fmt.Errorf("扫描积分流水数据失败: %w", err)
                        }</span>
                        <span class="cov0" title="0">transactions = append(transactions, &amp;txn)</span>
                }

                <span class="cov0" title="0">return transactionResult{
                        Transactions: transactions,
                        Total:        total,
                }, nil</span>
        })
        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                return nil, 0, err
        }</span>
        <span class="cov0" title="0">return result.Transactions, result.Total, nil</span>
}

// AdjustUserCredits 管理员调整积分（需记录审计日志）
func (d *Database) AdjustUserCredits(adminID, userID string, amount int, reason, ipAddress string) error <span class="cov0" title="0">{
        if amount == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("调整积分数量不能为0")
        }</span>

        // 确定操作类型
        <span class="cov0" title="0">operation := "增加"
        if amount &lt; 0 </span><span class="cov0" title="0">{
                operation = "扣减"
        }</span>

        <span class="cov0" title="0">description := fmt.Sprintf("管理员 %s %s 积分: %s (原因: %s)",
                adminID, operation, userID, reason)

        // 记录审计日志
        auditDetails := fmt.Sprintf("操作: %s, 目标用户: %s, 积分数量: %d, 原因: %s",
                operation, userID, amount, reason)
        if err := d.CreateAuditLog(&amp;adminID, "ADMIN_ADJUST_CREDITS", ipAddress, "", true, auditDetails); err != nil </span><span class="cov0" title="0">{
                log.Printf("⚠️ 记录审计日志失败: %v", err)
        }</span>

        <span class="cov0" title="0">_, err := withRetry(func() (bool, error) </span><span class="cov0" title="0">{
                // 开始事务
                tx, err := d.db.Begin()
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("开始事务失败: %w", err)
                }</span>
                <span class="cov0" title="0">defer tx.Rollback()

                // 获取或创建用户积分账户
                var userCreditsID int
                var availableCredits, totalCredits, usedCredits int
                var createdAt, updatedAt time.Time

                err = tx.QueryRow(`
                        SELECT id, available_credits, total_credits, used_credits, created_at, updated_at
                        FROM user_credits
                        WHERE user_id = $1
                        FOR UPDATE
                `, userID).Scan(&amp;userCreditsID, &amp;availableCredits, &amp;totalCredits, &amp;usedCredits, &amp;createdAt, &amp;updatedAt)

                var isNewAccount bool
                if err != nil </span><span class="cov0" title="0">{
                        if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                                // 用户没有积分账户，创建新的
                                isNewAccount = true
                                availableCredits = 0
                                totalCredits = 0
                                usedCredits = 0
                                createdAt = time.Now()
                                updatedAt = time.Now()
                        }</span> else<span class="cov0" title="0"> {
                                return false, fmt.Errorf("查询用户积分记录失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">var newAvailableCredits, newTotalCredits, newUsedCredits int
                var txnType, category string

                if amount &gt; 0 </span><span class="cov0" title="0">{
                        // 增加积分
                        newAvailableCredits = availableCredits + amount
                        newTotalCredits = totalCredits + amount
                        newUsedCredits = usedCredits
                        txnType = "credit"
                        category = "admin"
                }</span> else<span class="cov0" title="0"> {
                        // 扣减积分
                        if availableCredits &lt; -amount </span><span class="cov0" title="0">{
                                return false, fmt.Errorf("积分不足: 当前可用积分 %d，需要扣减 %d", availableCredits, -amount)
                        }</span>
                        <span class="cov0" title="0">newAvailableCredits = availableCredits + amount
                        newTotalCredits = totalCredits
                        newUsedCredits = usedCredits - amount // 实际使用的积分增加
                        txnType = "debit"
                        category = "admin"</span>
                }

                <span class="cov0" title="0">if isNewAccount </span><span class="cov0" title="0">{
                        // 创建新的积分账户
                        _, err = tx.Exec(`
                                INSERT INTO user_credits
                                (id, user_id, available_credits, total_credits, used_credits, created_at, updated_at)
                                VALUES ($1, $2, $3, $4, $5, $6, $7)
                        `, GenerateUUID(), userID, newAvailableCredits, newTotalCredits, newUsedCredits, createdAt, updatedAt)
                }</span> else<span class="cov0" title="0"> {
                        // 更新现有积分账户
                        _, err = tx.Exec(`
                                UPDATE user_credits
                                SET available_credits = $1, total_credits = $2, used_credits = $3, updated_at = CURRENT_TIMESTAMP
                                WHERE user_id = $4
                        `, newAvailableCredits, newTotalCredits, newUsedCredits, userID)
                }</span>

                <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("更新用户积分失败: %w", err)
                }</span>

                // 记录积分流水
                <span class="cov0" title="0">_, err = tx.Exec(`
                        INSERT INTO credit_transactions
                        (id, user_id, type, amount, balance_before, balance_after, category, description, reference_id, created_at)
                        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, CURRENT_TIMESTAMP)
                `, GenerateUUID(), userID, txnType, amount, availableCredits, newAvailableCredits,
                        category, description, adminID)
                if err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("记录积分流水失败: %w", err)
                }</span>

                // 提交事务
                <span class="cov0" title="0">if err := tx.Commit(); err != nil </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("提交事务失败: %w", err)
                }</span>

                <span class="cov0" title="0">log.Printf("✅ 管理员 %s %s 用户 %s 积分 %d (原因: %s)",
                        adminID, operation, userID, amount, reason)
                return true, nil</span>
        })
        <span class="cov0" title="0">return err</span>
}

// CreateCreditPackage 创建积分套餐
func (d *Database) CreateCreditPackage(pkg *CreditPackage) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO credit_packages
                (id, name, name_en, description, price_usdt, credits, bonus_credits,
                 is_active, is_recommended, sort_order, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
        `, pkg.ID, pkg.Name, pkg.NameEN, pkg.Description, pkg.PriceUSDT,
                pkg.Credits, pkg.BonusCredits, pkg.IsActive, pkg.IsRecommended,
                pkg.SortOrder, pkg.CreatedAt, pkg.UpdatedAt)
        return err
}</span>

// UpdateCreditPackage 更新积分套餐
func (d *Database) UpdateCreditPackage(pkg *CreditPackage) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE credit_packages SET
                        name = $1, name_en = $2, description = $3, price_usdt = $4,
                        credits = $5, bonus_credits = $6, is_active = $7, is_recommended = $8,
                        sort_order = $9, updated_at = CURRENT_TIMESTAMP
                WHERE id = $10
        `, pkg.Name, pkg.NameEN, pkg.Description, pkg.PriceUSDT,
                pkg.Credits, pkg.BonusCredits, pkg.IsActive, pkg.IsRecommended,
                pkg.SortOrder, pkg.ID)
        return err
}</span>

// DeleteCreditPackage 删除积分套餐（软删除）
func (d *Database) DeleteCreditPackage(id string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE credit_packages SET is_active = false, updated_at = CURRENT_TIMESTAMP
                WHERE id = $1
        `, id)
        return err
}</span>

// GetAllCreditPackages 获取所有套餐（包括禁用的）
func (d *Database) GetAllCreditPackages() ([]*CreditPackage, error) <span class="cov0" title="0">{
        return withRetry(func() ([]*CreditPackage, error) </span><span class="cov0" title="0">{
                rows, err := d.query(`
                        SELECT id, name, name_en, description, price_usdt, credits, bonus_credits,
                                   is_active, is_recommended, sort_order, created_at, updated_at
                        FROM credit_packages
                        ORDER BY sort_order ASC, created_at ASC
                `)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">defer rows.Close()

                packages := make([]*CreditPackage, 0)
                for rows.Next() </span><span class="cov0" title="0">{
                        var pkg CreditPackage
                        err := rows.Scan(
                                &amp;pkg.ID, &amp;pkg.Name, &amp;pkg.NameEN, &amp;pkg.Description, &amp;pkg.PriceUSDT,
                                &amp;pkg.Credits, &amp;pkg.BonusCredits, &amp;pkg.IsActive, &amp;pkg.IsRecommended,
                                &amp;pkg.SortOrder, &amp;pkg.CreatedAt, &amp;pkg.UpdatedAt,
                        )
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov0" title="0">packages = append(packages, &amp;pkg)</span>
                }

                <span class="cov0" title="0">return packages, nil</span>
        })
}

// GetUserCreditSummary 获取用户积分摘要
func (d *Database) GetUserCreditSummary(userID string) (map[string]interface{}, error) <span class="cov0" title="0">{
        return withRetry(func() (map[string]interface{}, error) </span><span class="cov0" title="0">{
                // 获取用户积分
                credits, err := d.GetUserCredits(userID)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("获取用户积分失败: %w", err)
                }</span>

                // 获取本月消费
                <span class="cov0" title="0">var monthlyConsumption int
                err = d.queryRow(`
                        SELECT COALESCE(SUM(amount), 0)
                        FROM credit_transactions
                        WHERE user_id = $1 AND type = 'debit'
                        AND created_at &gt;= date_trunc('month', CURRENT_DATE)
                `, userID).Scan(&amp;monthlyConsumption)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("获取本月消费失败: %w", err)
                }</span>

                // 获取本月充值
                <span class="cov0" title="0">var monthlyRecharge int
                err = d.queryRow(`
                        SELECT COALESCE(SUM(amount), 0)
                        FROM credit_transactions
                        WHERE user_id = $1 AND type = 'credit' AND category = 'purchase'
                        AND created_at &gt;= date_trunc('month', CURRENT_DATE)
                `, userID).Scan(&amp;monthlyRecharge)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("获取本月充值失败: %w", err)
                }</span>

                // 获取总交易笔数
                <span class="cov0" title="0">var totalTransactions int
                err = d.queryRow(`
                        SELECT COUNT(*) FROM credit_transactions WHERE user_id = $1
                `, userID).Scan(&amp;totalTransactions)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("获取总交易笔数失败: %w", err)
                }</span>

                <span class="cov0" title="0">summary := map[string]interface{}{
                        "available_credits":      credits.AvailableCredits,
                        "total_credits":          credits.TotalCredits,
                        "used_credits":           credits.UsedCredits,
                        "monthly_consumption":    monthlyConsumption,
                        "monthly_recharge":       monthlyRecharge,
                        "total_transactions":     totalTransactions,
                        "last_updated":           credits.UpdatedAt,
                }

                return summary, nil</span>
        })
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package config

import (
        "fmt"
        "log"
)

// CreditSystemExample 积分系统使用示例
// 此文件展示了如何使用积分系统的各种功能

func CreditSystemUsageExample() <span class="cov0" title="0">{
        // 注意：这是一个示例函数，实际使用时需要传入真实的数据库实例
        // db := config.NewDatabase(databaseURL)
        // defer db.Close()

        log.Println("=== 积分系统使用示例 ===")

        // 示例1: 获取所有启用的积分套餐
        /*
                packages, err := db.GetActivePackages()
                if err != nil {
                        log.Printf("获取积分套餐失败: %v", err)
                        return
                }

                fmt.Println("\n📦 可用积分套餐:")
                for _, pkg := range packages {
                        totalCredits := pkg.Credits + pkg.BonusCredits
                        fmt.Printf("  - %s (%s): %.2f USDT\n", pkg.Name, pkg.NameEN, pkg.PriceUSDT)
                        fmt.Printf("    积分: %d + %d赠送 = %d总积分\n", pkg.Credits, pkg.BonusCredits, totalCredits)
                        fmt.Printf("    描述: %s\n", pkg.Description)
                        if pkg.IsRecommended {
                                fmt.Println("    ⭐ 推荐套餐")
                        }
                        fmt.Println()
                }
        */

        // 示例2: 用户积分操作流程
        /*
                // 2.1 获取或创建用户积分账户
                credits, err := db.GetOrCreateUserCredits(userID)
                if err != nil {
                        log.Printf("创建用户积分账户失败: %v", err)
                        return
                }

                fmt.Printf("👤 用户积分账户: %+v\n", credits)

                // 2.2 增加积分（购买套餐后）
                purchaseAmount := 500
                err = db.AddCredits(userID, purchaseAmount, "purchase",
                        "购买标准套餐", "order_abc123")
                if err != nil {
                        log.Printf("增加积分失败: %v", err)
                        return
                }

                fmt.Printf("✅ 成功增加 %d 积分\n", purchaseAmount)

                // 2.3 检查积分是否充足
                if db.HasEnoughCredits(userID, 100) {
                        fmt.Println("✅ 积分充足，可以消费")

                        // 2.4 扣减积分（使用服务）
                        err = db.DeductCredits(userID, 100, "consume",
                                "AI交易分析服务", "service_xyz789")
                        if err != nil {
                                log.Printf("扣减积分失败: %v", err)
                                return
                        }

                        fmt.Println("✅ 成功扣减 100 积分")
                } else {
                        fmt.Println("❌ 积分不足")
                }

                // 2.5 获取用户积分流水
                transactions, total, err := db.GetUserTransactions(userID, 1, 10)
                if err != nil {
                        log.Printf("获取积分流水失败: %v", err)
                        return
                }

                fmt.Printf("\n📊 积分流水 (共 %d 条):\n", total)
                for i, txn := range transactions {
                        if i &gt;= 5 { // 只显示前5条
                                break
                        }
                        fmt.Printf("  [%s] %s %d积分 (余额: %d)\n",
                                txn.Type, txn.Description, txn.Amount, txn.BalanceAfter)
                        fmt.Printf("      类别: %s, 时间: %s\n", txn.Category, txn.CreatedAt.Format("2006-01-02 15:04:05"))
                }

                // 2.6 获取用户积分摘要
                summary, err := db.GetUserCreditSummary(userID)
                if err != nil {
                        log.Printf("获取积分摘要失败: %v", err)
                        return
                }

                fmt.Printf("\n📈 用户积分摘要:\n")
                fmt.Printf("  可用积分: %d\n", summary["available_credits"])
                fmt.Printf("  总积分: %d\n", summary["total_credits"])
                fmt.Printf("  已用积分: %d\n", summary["used_credits"])
                fmt.Printf("  本月消费: %d\n", summary["monthly_consumption"])
                fmt.Printf("  本月充值: %d\n", summary["monthly_recharge"])
                fmt.Printf("  总交易笔数: %d\n", summary["total_transactions"])
        */

        // 示例3: 管理员操作
        /*
                adminID := "admin_001"

                // 3.1 管理员调整用户积分
                err = db.AdjustUserCredits(adminID, userID, 1000, "新用户奖励", "192.168.1.1")
                if err != nil {
                        log.Printf("管理员调整积分失败: %v", err)
                        return
                }

                fmt.Println("✅ 管理员成功调整用户积分")

                // 3.2 管理员调整积分（扣减）
                err = db.AdjustUserCredits(adminID, userID, -500, "违规处罚", "192.168.1.1")
                if err != nil {
                        log.Printf("管理员扣减积分失败: %v", err)
                        return
                }

                fmt.Println("✅ 管理员成功扣减用户积分")
        */

        // 示例4: 创建自定义积分套餐
        /*
                now := time.Now()
                customPackage := &amp;CreditPackage{
                        ID:            "custom_888",
                        Name:          "自定义套餐",
                        NameEN:        "Custom Package",
                        Description:   "888积分个性套餐",
                        PriceUSDT:     66.66,
                        Credits:       888,
                        BonusCredits:  88,
                        IsActive:      true,
                        IsRecommended: false,
                        SortOrder:     5,
                        CreatedAt:     now,
                        UpdatedAt:     now,
                }

                err = db.CreateCreditPackage(customPackage)
                if err != nil {
                        log.Printf("创建自定义套餐失败: %v", err)
                        return
                }

                fmt.Println("✅ 成功创建自定义积分套餐")
        */

        fmt.Println("\n=== 积分系统使用示例完成 ===")
}</span>

// 积分套餐管理示例
func CreditPackageManagementExample() <span class="cov0" title="0">{
        // db := config.NewDatabase(databaseURL)
        // defer db.Close()

        log.Println("\n=== 积分套餐管理示例 ===")

        // 获取所有套餐（包括禁用的）
        /*
                packages, err := db.GetAllCreditPackages()
                if err != nil {
                        log.Printf("获取所有套餐失败: %v", err)
                        return
                }

                fmt.Println("\n📦 所有积分套餐:")
                for _, pkg := range packages {
                        status := "✅ 启用"
                        if !pkg.IsActive {
                                status = "❌ 禁用"
                        }

                        recommend := ""
                        if pkg.IsRecommended {
                                recommend = " ⭐"
                        }

                        fmt.Printf("  [%s] %s - %.2f USDT (%d积分)%s\n",
                                status, pkg.Name, pkg.PriceUSDT, pkg.Credits, recommend)
                }
        */

        // 根据ID获取套餐
        /*
                pkg, err := db.GetPackageByID("standard_500")
                if err != nil {
                        log.Printf("获取套餐失败: %v", err)
                        return
                }

                fmt.Printf("\n📦 套餐详情:\n")
                fmt.Printf("  ID: %s\n", pkg.ID)
                fmt.Printf("  名称: %s\n", pkg.Name)
                fmt.Printf("  英文名: %s\n", pkg.NameEN)
                fmt.Printf("  价格: %.2f USDT\n", pkg.PriceUSDT)
                fmt.Printf("  积分: %d + %d赠送\n", pkg.Credits, pkg.BonusCredits)
                fmt.Printf("  描述: %s\n", pkg.Description)
                fmt.Printf("  状态: %v\n", pkg.IsActive)
                fmt.Printf("  推荐: %v\n", pkg.IsRecommended)
                fmt.Printf("  排序: %d\n", pkg.SortOrder)
        */

        // 更新套餐
        /*
                pkg.IsRecommended = true
                pkg.BonusCredits = 100
                pkg.UpdatedAt = time.Now()

                err = db.UpdateCreditPackage(pkg)
                if err != nil {
                        log.Printf("更新套餐失败: %v", err)
                        return
                }

                fmt.Println("✅ 成功更新套餐")
        */

        // 删除套餐（软删除）
        /*
                err = db.DeleteCreditPackage("custom_888")
                if err != nil {
                        log.Printf("删除套餐失败: %v", err)
                        return
                }

                fmt.Println("✅ 成功删除套餐")
        */

        fmt.Println("\n=== 积分套餐管理示例完成 ===")
}</span>

// 错误处理示例
func CreditSystemErrorHandlingExample() <span class="cov0" title="0">{
        // db := config.NewDatabase(databaseURL)
        // defer db.Close()

        log.Println("\n=== 错误处理示例 ===")

        // 示例1: 积分不足错误
        /*
                userID := "user_error_test"
                err := db.DeductCredits(userID, 1000, "consume", "测试消费", "test_001")
                if err != nil {
                        if err.Error() == "积分不足" {
                                fmt.Printf("❌ 积分不足: %v\n", err)
                        } else {
                                log.Printf("❌ 扣减积分失败: %v", err)
                        }
                }
        */

        // 示例2: 无效数量错误
        /*
                err := db.AddCredits(userID, 0, "purchase", "测试购买", "test_002")
                if err != nil {
                        fmt.Printf("❌ 增加积分失败: %v\n", err)
                }
        */

        // 示例3: 管理员扣减积分时积分不足
        /*
                adminID := "admin_001"
                err := db.AdjustUserCredits(adminID, userID, -2000, "测试扣减", "192.168.1.100")
                if err != nil {
                        if err.Error() == "积分不足" {
                                fmt.Printf("❌ 管理员扣减失败: %v\n", err)
                        } else {
                                log.Printf("❌ 管理员操作失败: %v", err)
                        }
                }
        */

        fmt.Println("\n=== 错误处理示例完成 ===")
}</span>

// 积分流水分析示例
func CreditTransactionAnalysisExample() <span class="cov0" title="0">{
        // db := config.NewDatabase(databaseURL)
        // defer db.Close()

        log.Println("\n=== 积分流水分析示例 ===")

        // 示例: 获取用户积分流水并进行简单分析
        /*
                userID := "user_analysis_test"
                transactions, total, err := db.GetUserTransactions(userID, 1, 100)
                if err != nil {
                        log.Printf("获取积分流水失败: %v", err)
                        return
                }

                var totalCredit, totalDebit int
                var categoryStats map[string]int = make(map[string]int)

                fmt.Printf("\n📊 用户 %s 积分流水分析 (共 %d 条):\n", userID, total)

                for _, txn := range transactions {
                        if txn.Type == "credit" {
                                totalCredit += txn.Amount
                        } else {
                                totalDebit += txn.Amount
                        }

                        categoryStats[txn.Category]++
                }

                fmt.Printf("  总充值: %d 积分\n", totalCredit)
                fmt.Printf("  总消费: %d 积分\n", totalDebit)
                fmt.Printf("  净增: %d 积分\n", totalCredit-totalDebit)

                fmt.Println("\n  消费类别统计:")
                for category, count := range categoryStats {
                        fmt.Printf("    %s: %d 笔\n", category, count)
                }

                // 最近5笔流水
                fmt.Println("\n  最近5笔流水:")
                for i, txn := range transactions {
                        if i &gt;= 5 {
                                break
                        }
                        action := "⬆️ 充值"
                        if txn.Type == "debit" {
                                action = "⬇️ 消费"
                        }
                        fmt.Printf("    %s %s %d积分 (余额: %d) - %s\n",
                                action, txn.Description, txn.Amount, txn.BalanceAfter, txn.CreatedAt.Format("2006-01-02 15:04:05"))
                }
        */

        fmt.Println("\n=== 积分流水分析示例完成 ===")
}</span>

// 完整的用户购买套餐流程示例
func CompletePurchaseFlowExample() <span class="cov0" title="0">{
        // db := config.NewDatabase(databaseURL)
        // defer db.Close()

        log.Println("\n=== 完整购买套餐流程示例 ===")

        /*
                // Step 1: 检查套餐是否存在
                userID := "user_purchase_test"
                packageID := "standard_500"
                pkg, err := db.GetPackageByID(packageID)
                if err != nil {
                        log.Printf("获取套餐失败: %v", err)
                        return
                }

                fmt.Printf("📦 选择的套餐: %s\n", pkg.Name)
                fmt.Printf("   价格: %.2f USDT\n", pkg.PriceUSDT)
                fmt.Printf("   积分: %d + %d赠送 = %d总积分\n",
                        pkg.Credits, pkg.BonusCredits, pkg.Credits+pkg.BonusCredits)

                // Step 2: 这里应该是支付流程，支付成功后继续...
                fmt.Println("\n💳 [支付流程] 模拟支付 %.2f USDT...", pkg.PriceUSDT)
                // 支付成功，获取支付订单ID
                paymentOrderID := "payment_" + GenerateUUID()
                fmt.Println("✅ 支付成功，订单ID:", paymentOrderID)

                // Step 3: 计算实际获得的积分
                totalCredits := pkg.Credits + pkg.BonusCredits
                fmt.Printf("\n💰 支付成功! 获得 %d 积分\n", totalCredits)

                // Step 4: 为用户增加积分
                err = db.AddCredits(userID, totalCredits, "purchase",
                        fmt.Sprintf("购买套餐: %s", pkg.Name), paymentOrderID)
                if err != nil {
                        log.Printf("增加积分失败: %v", err)
                        return
                }

                fmt.Printf("✅ 成功为用户 %s 增加 %d 积分\n", userID, totalCredits)

                // Step 5: 验证积分到账
                credits, err := db.GetUserCredits(userID)
                if err != nil {
                        log.Printf("获取用户积分失败: %v", err)
                        return
                }

                fmt.Printf("\n💳 当前积分余额: %d 积分\n", credits.AvailableCredits)

                // Step 6: 记录订单完成状态（在实际应用中）
                fmt.Println("\n📝 [订单系统] 标记订单为已完成状态")
        */

        fmt.Println("\n=== 完整购买套餐流程示例完成 ===")
}</span>

func main() <span class="cov0" title="0">{
        // 运行所有示例
        CreditSystemUsageExample()
        CreditPackageManagementExample()
        CreditSystemErrorHandlingExample()
        CreditTransactionAnalysisExample()
        CompletePurchaseFlowExample()

        fmt.Println("\n🎉 所有积分系统示例运行完成!")
}</span>
</pre>
		
		<pre class="file" id="file4" style="display: none">package config

import (
        "crypto/rand"
        "database/sql"
        "encoding/base32"
        "encoding/json"
        "fmt"
        "log"
        "nofx/market"
        "os"
        "slices"
        "strings"
        "time"

        "github.com/google/uuid"
        _ "github.com/lib/pq"
)

// Database 配置数据库
type Database struct {
        db *sql.DB
}

// NewDatabase 创建配置数据库（仅支持PostgreSQL）
func NewDatabase(dbPath string) (*Database, error) <span class="cov0" title="0">{
        databaseURL := os.Getenv("DATABASE_URL")
        if databaseURL == "" </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("DATABASE_URL环境变量未设置")
        }</span>

        <span class="cov0" title="0">log.Println("🔄 连接PostgreSQL数据库...")
        db, err := sql.Open("postgres", databaseURL)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("连接数据库失败: %w", err)
        }</span>

        // 配置连接池 - 针对Neon PostgreSQL serverless优化
        // 这些设置有助于防止冷启动问题
        <span class="cov0" title="0">db.SetMaxOpenConns(10)                  // 最大打开连接数
        db.SetMaxIdleConns(5)                   // 最大空闲连接数
        db.SetConnMaxIdleTime(30 * time.Second) // 空闲连接最大存活时间
        db.SetConnMaxLifetime(5 * time.Minute)  // 连接最大生命周期
        log.Println("📋 数据库连接池配置: MaxOpen=10, MaxIdle=5, IdleTime=30s, Lifetime=5m")

        if pingErr := db.Ping(); pingErr != nil </span><span class="cov0" title="0">{
                db.Close()
                return nil, fmt.Errorf("数据库连接测试失败: %w", pingErr)
        }</span>

        <span class="cov0" title="0">log.Println("✅ 成功连接PostgreSQL数据库!")

        database := &amp;Database{db: db}
        log.Println("🔄 开始创建表...")
        if err := database.createTables(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("创建表失败: %w", err)
        }</span>
        <span class="cov0" title="0">log.Println("✅ 表创建成功!")

        log.Println("🔄 开始修改表结构...")
        if err := database.alterTables(); err != nil </span><span class="cov0" title="0">{
                log.Printf("⚠️ 数据库迁移警告: %v", err)
        }</span>
        <span class="cov0" title="0">log.Println("✅ 表结构修改完成!")

        log.Println("🔄 开始初始化默认数据...")
        if err := database.initDefaultData(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("初始化默认数据失败: %w", err)
        }</span>
        <span class="cov0" title="0">log.Println("✅ 默认数据初始化完成!")

        return database, nil</span>
}

// isTransientError 检查是否是可重试的临时错误
func isTransientError(err error) bool <span class="cov0" title="0">{
        if err == nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov0" title="0">errStr := err.Error()
        // Neon PostgreSQL冷启动和连接断开的常见错误
        // 参考: https://neon.com/docs/connect/connection-errors
        transientErrors := []string{
                "connection not available",
                "connection reset",
                "connection refused",
                "broken pipe",
                "EOF",
                "timeout",
                "no connection",
                "connection is closed",
                "unexpected EOF",
                "driver: bad connection",
                // Neon 特有的冷启动错误
                "terminating connection due to administrator command",
                "can't reach database server",
                "the database system is starting up",
                "connection timed out",
                "network is unreachable",
                "i/o timeout",
                "connection reset by peer",
                "no such host",
        }
        for _, te := range transientErrors </span><span class="cov0" title="0">{
                if strings.Contains(strings.ToLower(errStr), strings.ToLower(te)) </span><span class="cov0" title="0">{
                        return true
                }</span>
        }
        <span class="cov0" title="0">return false</span>
}

// withRetry 执行带重试的数据库操作
// 最多重试3次，使用指数退避策略（100ms, 200ms, 400ms）
func withRetry[T any](operation func() (T, error)) (T, error) <span class="cov0" title="0">{
        var result T
        var lastErr error
        maxRetries := 3
        baseDelay := 100 * time.Millisecond

        for attempt := 0; attempt &lt; maxRetries; attempt++ </span><span class="cov0" title="0">{
                result, lastErr = operation()
                if lastErr == nil </span><span class="cov0" title="0">{
                        return result, nil
                }</span>

                <span class="cov0" title="0">if !isTransientError(lastErr) </span><span class="cov0" title="0">{
                        // 非临时性错误，不重试
                        return result, lastErr
                }</span>

                <span class="cov0" title="0">if attempt &lt; maxRetries-1 </span><span class="cov0" title="0">{
                        delay := baseDelay * time.Duration(1&lt;&lt;attempt) // 指数退避: 100ms, 200ms, 400ms
                        log.Printf("⚠️ 数据库操作失败 (尝试 %d/%d): %v, %v后重试...", attempt+1, maxRetries, lastErr, delay)
                        time.Sleep(delay)
                }</span>
        }

        <span class="cov0" title="0">return result, fmt.Errorf("数据库操作重试%d次后仍失败: %w", maxRetries, lastErr)</span>
}

// Ping 检测数据库连接（带重试）
func (d *Database) Ping() error <span class="cov0" title="0">{
        _, err := withRetry(func() (bool, error) </span><span class="cov0" title="0">{
                return true, d.db.Ping()
        }</span>)
        <span class="cov0" title="0">return err</span>
}

// StartKeepAlive 启动后台连接保活协程
// 每5分钟执行一次ping，防止Neon PostgreSQL连接被断开
func (d *Database) StartKeepAlive() <span class="cov0" title="0">{
        go func() </span><span class="cov0" title="0">{
                ticker := time.NewTicker(5 * time.Minute)
                defer ticker.Stop()
                for range ticker.C </span><span class="cov0" title="0">{
                        if err := d.db.Ping(); err != nil </span><span class="cov0" title="0">{
                                log.Printf("⚠️ 数据库保活ping失败: %v", err)
                        }</span>
                }
        }()
        <span class="cov0" title="0">log.Println("🔄 数据库连接保活协程已启动 (每5分钟ping一次)")</span>
}

// convertPlaceholders 将?占位符转换为PostgreSQL的$1, $2格式
func (d *Database) convertPlaceholders(query string) string <span class="cov0" title="0">{
        result := query
        index := 1
        for strings.Contains(result, "?") </span><span class="cov0" title="0">{
                result = strings.Replace(result, "?", fmt.Sprintf("$%d", index), 1)
                index++
        }</span>
        <span class="cov0" title="0">return result</span>
}

// query 执行查询并自动转换占位符
func (d *Database) query(query string, args ...interface{}) (*sql.Rows, error) <span class="cov0" title="0">{
        return d.db.Query(d.convertPlaceholders(query), args...)
}</span>

// queryRow 执行单行查询并自动转换占位符
func (d *Database) queryRow(query string, args ...interface{}) *sql.Row <span class="cov0" title="0">{
        return d.db.QueryRow(d.convertPlaceholders(query), args...)
}</span>

// exec 执行语句并自动转换占位符
func (d *Database) exec(query string, args ...interface{}) (sql.Result, error) <span class="cov0" title="0">{
        return d.db.Exec(d.convertPlaceholders(query), args...)
}</span>

// createTables 创建数据库表
func (d *Database) createTables() error <span class="cov0" title="0">{
        return d.createTablesPostgres()
}</span>

// createTablesPostgres PostgreSQL版本的表创建
func (d *Database) createTablesPostgres() error <span class="cov0" title="0">{
        queries := []string{
                // 用户表 (必须先创建，因为其他表依赖它)
                `CREATE TABLE IF NOT EXISTS users (
                        id TEXT PRIMARY KEY,
                        email TEXT UNIQUE NOT NULL,
                        password_hash TEXT NOT NULL,
                        otp_secret TEXT,
                        otp_verified BOOLEAN DEFAULT false,
                        locked_until TIMESTAMP,
                        failed_attempts INTEGER DEFAULT 0,
                        last_failed_at TIMESTAMP,
                        is_active BOOLEAN DEFAULT true,
                        is_admin BOOLEAN DEFAULT false,
                        beta_code TEXT,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // AI模型配置表 (复合主键: id + user_id，支持多用户)
                `CREATE TABLE IF NOT EXISTS ai_models (
                        id TEXT NOT NULL,
                        user_id TEXT NOT NULL DEFAULT 'default',
                        name TEXT NOT NULL,
                        provider TEXT NOT NULL,
                        enabled BOOLEAN DEFAULT false,
                        api_key TEXT DEFAULT '',
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        PRIMARY KEY (id, user_id)
                )`,

                // 交易所配置表
                `CREATE TABLE IF NOT EXISTS exchanges (
                        id TEXT PRIMARY KEY,
                        user_id TEXT NOT NULL DEFAULT 'default',
                        name TEXT NOT NULL,
                        type TEXT NOT NULL,
                        enabled BOOLEAN DEFAULT false,
                        api_key TEXT DEFAULT '',
                        secret_key TEXT DEFAULT '',
                        testnet BOOLEAN DEFAULT false,
                        hyperliquid_wallet_addr TEXT DEFAULT '',
                        aster_user TEXT DEFAULT '',
                        aster_signer TEXT DEFAULT '',
                        aster_private_key TEXT DEFAULT '',
                        passphrase TEXT DEFAULT '',
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 用户信号源配置表
                `CREATE TABLE IF NOT EXISTS user_signal_sources (
                        id SERIAL PRIMARY KEY,
                        user_id TEXT NOT NULL UNIQUE,
                        coin_pool_url TEXT DEFAULT '',
                        oi_top_url TEXT DEFAULT '',
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 交易员配置表
                `CREATE TABLE IF NOT EXISTS traders (
                        id TEXT PRIMARY KEY,
                        user_id TEXT NOT NULL DEFAULT 'default',
                        name TEXT NOT NULL,
                        ai_model_id TEXT NOT NULL,
                        exchange_id TEXT NOT NULL,
                        initial_balance REAL NOT NULL,
                        scan_interval_minutes INTEGER DEFAULT 3,
                        is_running BOOLEAN DEFAULT false,
                        btc_eth_leverage INTEGER DEFAULT 5,
                        altcoin_leverage INTEGER DEFAULT 5,
                        trading_symbols TEXT DEFAULT '',
                        use_coin_pool BOOLEAN DEFAULT false,
                        use_oi_top BOOLEAN DEFAULT false,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 密码重置令牌表
                `CREATE TABLE IF NOT EXISTS password_resets (
                        id TEXT PRIMARY KEY,
                        user_id TEXT NOT NULL,
                        token_hash TEXT NOT NULL,
                        expires_at TIMESTAMP NOT NULL,
                        used_at TIMESTAMP,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 登录尝试记录表
                `CREATE TABLE IF NOT EXISTS login_attempts (
                        id TEXT PRIMARY KEY,
                        user_id TEXT,
                        email TEXT NOT NULL,
                        ip_address TEXT NOT NULL,
                        success BOOLEAN NOT NULL,
                        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        user_agent TEXT
                )`,

                // 审计日志表
                `CREATE TABLE IF NOT EXISTS audit_logs (
                        id TEXT PRIMARY KEY,
                        user_id TEXT,
                        action TEXT NOT NULL,
                        ip_address TEXT NOT NULL,
                        user_agent TEXT,
                        success BOOLEAN NOT NULL,
                        details TEXT,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 系统配置表
                `CREATE TABLE IF NOT EXISTS system_config (
                        key TEXT PRIMARY KEY,
                        value TEXT NOT NULL,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 内测码表
                `CREATE TABLE IF NOT EXISTS beta_codes (
                        code TEXT PRIMARY KEY,
                        used BOOLEAN DEFAULT false,
                        used_by TEXT DEFAULT '',
                        used_at TIMESTAMP DEFAULT NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 积分套餐表
                `CREATE TABLE IF NOT EXISTS credit_packages (
                        id TEXT PRIMARY KEY,
                        name TEXT NOT NULL,
                        name_en TEXT NOT NULL,
                        description TEXT DEFAULT '',
                        price_usdt REAL NOT NULL,
                        credits INTEGER NOT NULL,
                        bonus_credits INTEGER DEFAULT 0,
                        is_active BOOLEAN DEFAULT true,
                        is_recommended BOOLEAN DEFAULT false,
                        sort_order INTEGER DEFAULT 0,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 用户积分账户表
                `CREATE TABLE IF NOT EXISTS user_credits (
                        id TEXT PRIMARY KEY,
                        user_id TEXT NOT NULL UNIQUE,
                        available_credits INTEGER DEFAULT 0,
                        total_credits INTEGER DEFAULT 0,
                        used_credits INTEGER DEFAULT 0,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,

                // 积分流水表
                `CREATE TABLE IF NOT EXISTS credit_transactions (
                        id TEXT PRIMARY KEY,
                        user_id TEXT NOT NULL,
                        type TEXT NOT NULL, -- credit/debit
                        amount INTEGER NOT NULL,
                        balance_before INTEGER NOT NULL,
                        balance_after INTEGER NOT NULL,
                        category TEXT NOT NULL, -- purchase/consume/gift/refund/admin
                        description TEXT NOT NULL,
                        reference_id TEXT DEFAULT '',
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )`,
        }

        for _, query := range queries </span><span class="cov0" title="0">{
                if _, err := d.exec(query); err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("执行SQL失败: %w, SQL: %s", err, query[:min(100, len(query))])
                }</span>
        }

        <span class="cov0" title="0">log.Println("✅ PostgreSQL表创建成功")
        return nil</span>
}


// 执行数据库迁移查询
func (d *Database) executeQueries(queries []string) error <span class="cov0" title="0">{
        for _, query := range queries </span><span class="cov0" title="0">{
                if _, err := d.exec(query); err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("执行SQL失败 [%s]: %w", query, err)
                }</span>
        }
        <span class="cov0" title="0">return nil</span>
}

// 为现有数据库添加新字段（向后兼容）
func (d *Database) alterTables() error <span class="cov0" title="0">{
        alterQueries := []string{
                // 添加users表缺失的字段
                `ALTER TABLE users ADD COLUMN locked_until TIMESTAMP`,
                `ALTER TABLE users ADD COLUMN failed_attempts INTEGER DEFAULT 0`,
                `ALTER TABLE users ADD COLUMN last_failed_at TIMESTAMP`,
                `ALTER TABLE users ADD COLUMN is_active BOOLEAN DEFAULT 1`,
                `ALTER TABLE users ADD COLUMN is_admin BOOLEAN DEFAULT 0`,
                `ALTER TABLE users ADD COLUMN beta_code TEXT`,
                // 添加exchanges表字段
                `ALTER TABLE exchanges ADD COLUMN hyperliquid_wallet_addr TEXT DEFAULT ''`,
                `ALTER TABLE exchanges ADD COLUMN aster_user TEXT DEFAULT ''`,
                `ALTER TABLE exchanges ADD COLUMN aster_signer TEXT DEFAULT ''`,
                `ALTER TABLE exchanges ADD COLUMN aster_private_key TEXT DEFAULT ''`,
                `ALTER TABLE exchanges ADD COLUMN okx_passphrase TEXT DEFAULT ''`,
                // 添加traders表字段
                `ALTER TABLE traders ADD COLUMN custom_prompt TEXT DEFAULT ''`,
                `ALTER TABLE traders ADD COLUMN override_base_prompt BOOLEAN DEFAULT 0`,
                `ALTER TABLE traders ADD COLUMN is_cross_margin BOOLEAN DEFAULT 1`,             // 默认为全仓模式
                `ALTER TABLE traders ADD COLUMN use_default_coins BOOLEAN DEFAULT 1`,           // 默认使用默认币种
                `ALTER TABLE traders ADD COLUMN custom_coins TEXT DEFAULT ''`,                  // 自定义币种列表（JSON格式）
                `ALTER TABLE traders ADD COLUMN btc_eth_leverage INTEGER DEFAULT 5`,            // BTC/ETH杠杆倍数
                `ALTER TABLE traders ADD COLUMN altcoin_leverage INTEGER DEFAULT 5`,            // 山寨币杠杆倍数
                `ALTER TABLE traders ADD COLUMN trading_symbols TEXT DEFAULT ''`,               // 交易币种，逗号分隔
                `ALTER TABLE traders ADD COLUMN use_coin_pool BOOLEAN DEFAULT 0`,               // 是否使用COIN POOL信号源
                `ALTER TABLE traders ADD COLUMN use_oi_top BOOLEAN DEFAULT 0`,                  // 是否使用OI TOP信号源
                `ALTER TABLE traders ADD COLUMN system_prompt_template TEXT DEFAULT 'default'`, // 系统提示词模板名称
                // 添加ai_models表字段
                `ALTER TABLE ai_models ADD COLUMN custom_api_url TEXT DEFAULT ''`,              // 自定义API地址
                `ALTER TABLE ai_models ADD COLUMN custom_model_name TEXT DEFAULT ''`,           // 自定义模型名称
        }

        for _, query := range alterQueries </span><span class="cov0" title="0">{
                // 忽略已存在字段的错误
                d.exec(query)
        }</span>

        // 检查是否需要迁移exchanges表的主键结构
        <span class="cov0" title="0">err := d.migrateExchangesTable()
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("⚠️ 迁移exchanges表失败: %v", err)
        }</span>

        // 检查是否需要迁移ai_models表的主键结构（从单主键id改为复合主键id+user_id）
        <span class="cov0" title="0">err = d.migrateAIModelsTable()
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("⚠️ 迁移ai_models表失败: %v", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// initDefaultData 初始化默认数据
func (d *Database) initDefaultData() error <span class="cov0" title="0">{
        // 确保default系统用户存在（必须在初始化默认数据之前）
        if err := d.EnsureDefaultUser(); err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建default用户失败: %w", err)
        }</span>

        // 确保admin用户存在（如果启用admin模式）
        <span class="cov0" title="0">if err := d.EnsureAdminUser(); err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建admin用户失败: %w", err)
        }</span>

        // 初始化AI模型（为default和admin用户都创建）
        <span class="cov0" title="0">aiModels := []struct {
                id, name, provider string
        }{
                {"deepseek", "DeepSeek", "deepseek"},
                {"qwen", "Qwen", "qwen"},
        }

        // 需要初始化模型的用户列表
        modelUsers := []string{"default", "admin"}

        for _, userID := range modelUsers </span><span class="cov0" title="0">{
                for _, model := range aiModels </span><span class="cov0" title="0">{
                        _, err := d.exec(`
                                INSERT INTO ai_models (id, user_id, name, provider, enabled)
                                VALUES ($1, $2, $3, $4, false)
                                ON CONFLICT (id, user_id) DO NOTHING
                        `, model.id, userID, model.name, model.provider)
                        if err != nil </span><span class="cov0" title="0">{
                                return fmt.Errorf("初始化AI模型失败 (user=%s, model=%s): %w", userID, model.id, err)
                        }</span>
                }
        }

        // 初始化交易所（使用default用户）
        <span class="cov0" title="0">exchanges := []struct {
                id, name, typ string
        }{
                {"binance", "Binance Futures", "cex"},
                {"hyperliquid", "Hyperliquid", "dex"},
                {"aster", "Aster DEX", "dex"},
                {"okx", "OKX Futures", "cex"},
        }

        for _, exchange := range exchanges </span><span class="cov0" title="0">{
                _, err := d.exec(`
                        INSERT INTO exchanges (id, user_id, name, type, enabled)
                        VALUES ($1, 'default', $2, $3, false)
                        ON CONFLICT (id, user_id) DO NOTHING
                `, exchange.id, exchange.name, exchange.typ)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("初始化交易所失败: %w", err)
                }</span>
        }

        // 初始化系统配置 - 创建所有字段，设置默认值，后续由config.json同步更新
        <span class="cov0" title="0">systemConfigs := map[string]string{
                "admin_mode":            "true",
                "beta_mode":             "false",
                "api_server_port":       "8080",
                "use_default_coins":     "true",
                "default_coins":         `["BTCUSDT","ETHUSDT","SOLUSDT","BNBUSDT","XRPUSDT","DOGEUSDT","ADAUSDT","HYPEUSDT"]`,
                "max_daily_loss":        "10.0",
                "max_drawdown":          "20.0",
                "stop_trading_minutes":  "60",
                "btc_eth_leverage":      "5",
                "altcoin_leverage":      "5",
                "jwt_secret":            "",
        }

        for key, value := range systemConfigs </span><span class="cov0" title="0">{
                _, err := d.exec(`
                        INSERT INTO system_config (key, value)
                        VALUES ($1, $2)
                        ON CONFLICT (key) DO NOTHING
                `, key, value)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("初始化系统配置失败: %w", err)
                }</span>
        }

        // 初始化默认积分套餐
        <span class="cov0" title="0">creditPackages := []struct {
                id, name, nameEn, description string
                priceUSDT                     float64
                credits, bonusCredits         int
                isActive, isRecommended       bool
                sortOrder                     int
        }{
                {
                        id:              "basic_100",
                        name:            "基础套餐",
                        nameEn:          "Basic Package",
                        description:     "100积分，AI交易入门首选",
                        priceUSDT:       9.99,
                        credits:         100,
                        bonusCredits:    0,
                        isActive:        true,
                        isRecommended:   false,
                        sortOrder:       1,
                },
                {
                        id:              "standard_500",
                        name:            "标准套餐",
                        nameEn:          "Standard Package",
                        description:     "500积分 + 50积分赠送，推荐选择",
                        priceUSDT:       39.99,
                        credits:         500,
                        bonusCredits:    50,
                        isActive:        true,
                        isRecommended:   true,
                        sortOrder:       2,
                },
                {
                        id:              "premium_1200",
                        name:            "高级套餐",
                        nameEn:          "Premium Package",
                        description:     "1200积分 + 200积分赠送，优惠更多",
                        priceUSDT:       79.99,
                        credits:         1200,
                        bonusCredits:    200,
                        isActive:        true,
                        isRecommended:   false,
                        sortOrder:       3,
                },
                {
                        id:              "enterprise_3000",
                        name:            "企业套餐",
                        nameEn:          "Enterprise Package",
                        description:     "3000积分 + 600积分赠送，大额优惠",
                        priceUSDT:       199.99,
                        credits:         3000,
                        bonusCredits:    600,
                        isActive:        true,
                        isRecommended:   false,
                        sortOrder:       4,
                },
        }

        for _, pkg := range creditPackages </span><span class="cov0" title="0">{
                now := time.Now()
                _, err := d.exec(`
                        INSERT INTO credit_packages
                        (id, name, name_en, description, price_usdt, credits, bonus_credits,
                         is_active, is_recommended, sort_order, created_at, updated_at)
                        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
                        ON CONFLICT (id) DO NOTHING
                `, pkg.id, pkg.name, pkg.nameEn, pkg.description, pkg.priceUSDT,
                        pkg.credits, pkg.bonusCredits, pkg.isActive, pkg.isRecommended,
                        pkg.sortOrder, now, now)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("初始化积分套餐失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return nil</span>
}

// migrateExchangesTable 迁移exchanges表支持多用户
func (d *Database) migrateExchangesTable() error <span class="cov0" title="0">{
        // PostgreSQL不需要这个迁移，已经在createTablesPostgres中创建了正确的表结构
        return nil
}</span>

// migrateAIModelsTable 迁移ai_models表从单主键id改为复合主键(id, user_id)
// 使用 RENAME + CREATE 策略确保原子性和数据安全
func (d *Database) migrateAIModelsTable() error <span class="cov0" title="0">{
        // 检查当前主键结构
        var constraintCols int
        err := d.queryRow(`
                SELECT COUNT(*) FROM information_schema.key_column_usage 
                WHERE table_name = 'ai_models' 
                AND constraint_name = 'ai_models_pkey'
        `).Scan(&amp;constraintCols)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("检查ai_models主键失败: %w", err)
        }</span>

        // 如果主键只有1列，说明还是老结构，需要迁移
        <span class="cov0" title="0">if constraintCols == 1 </span><span class="cov0" title="0">{
                log.Println("🔄 迁移ai_models表主键结构...")

                // 检查是否有之前迁移失败遗留的备份表，如果有则从备份恢复
                var backupExists int
                d.queryRow(`SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'ai_models_old'`).Scan(&amp;backupExists)
                if backupExists &gt; 0 </span><span class="cov0" title="0">{
                        log.Println("⚠️ 检测到之前迁移失败的备份表，尝试恢复...")
                        // 删除可能的不完整新表，恢复旧表
                        d.exec(`DROP TABLE IF EXISTS ai_models`)
                        _, err = d.exec(`ALTER TABLE ai_models_old RENAME TO ai_models`)
                        if err != nil </span><span class="cov0" title="0">{
                                return fmt.Errorf("从备份恢复失败: %w", err)
                        }</span>
                        <span class="cov0" title="0">log.Println("✅ 从备份恢复成功，重新开始迁移")</span>
                }

                // 1. 重命名原表为备份（原子操作，保留原始数据）
                <span class="cov0" title="0">_, err = d.exec(`ALTER TABLE ai_models RENAME TO ai_models_old`)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("重命名ai_models表失败: %w", err)
                }</span>

                // 2. 创建新表（复合主键）
                <span class="cov0" title="0">_, err = d.exec(`
                        CREATE TABLE ai_models (
                                id TEXT NOT NULL,
                                user_id TEXT NOT NULL DEFAULT 'default',
                                name TEXT NOT NULL,
                                provider TEXT NOT NULL,
                                enabled BOOLEAN DEFAULT false,
                                api_key TEXT DEFAULT '',
                                custom_api_url TEXT DEFAULT '',
                                custom_model_name TEXT DEFAULT '',
                                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                PRIMARY KEY (id, user_id)
                        )
                `)
                if err != nil </span><span class="cov0" title="0">{
                        // 创建失败，恢复原表名
                        d.exec(`ALTER TABLE ai_models_old RENAME TO ai_models`)
                        return fmt.Errorf("创建新ai_models表失败: %w", err)
                }</span>

                // 3. 迁移数据
                <span class="cov0" title="0">_, err = d.exec(`
                        INSERT INTO ai_models (id, user_id, name, provider, enabled, api_key, custom_api_url, custom_model_name, created_at, updated_at)
                        SELECT id, user_id, name, provider, enabled, COALESCE(api_key, ''), COALESCE(custom_api_url, ''), COALESCE(custom_model_name, ''), created_at, updated_at
                        FROM ai_models_old
                `)
                if err != nil </span><span class="cov0" title="0">{
                        // 迁移失败，恢复原表
                        d.exec(`DROP TABLE ai_models`)
                        d.exec(`ALTER TABLE ai_models_old RENAME TO ai_models`)
                        return fmt.Errorf("迁移ai_models数据失败: %w", err)
                }</span>

                // 4. 删除备份表（迁移成功后）
                <span class="cov0" title="0">_, err = d.exec(`DROP TABLE ai_models_old`)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("⚠️ 删除备份表失败: %v (可手动删除)", err)
                }</span>

                <span class="cov0" title="0">log.Println("✅ ai_models表主键迁移完成")</span>
        }

        <span class="cov0" title="0">return nil</span>
}

// User 用户配置
type User struct {
        ID             string     `json:"id"`
        Email          string     `json:"email"`
        PasswordHash   string     `json:"-"` // 不返回到前端
        OTPSecret      string     `json:"-"` // 不返回到前端
        OTPVerified    bool       `json:"otp_verified"`
        LockedUntil    *time.Time `json:"-"` // 账户锁定到期时间，不返回前端
        FailedAttempts int        `json:"-"` // 失败尝试次数，不返回前端
        LastFailedAt   *time.Time `json:"-"` // 最后失败时间，不返回前端
        IsActive       bool       `json:"is_active"`
        IsAdmin        bool       `json:"is_admin"`
        BetaCode       string     `json:"-"` // 内测码，不返回前端
        CreatedAt      time.Time  `json:"created_at"`
        UpdatedAt      time.Time  `json:"updated_at"`
}

// AIModelConfig AI模型配置
type AIModelConfig struct {
        ID              string    `json:"id"`
        UserID          string    `json:"user_id"`
        Name            string    `json:"name"`
        Provider        string    `json:"provider"`
        Enabled         bool      `json:"enabled"`
        APIKey          string    `json:"apiKey"`
        CustomAPIURL    string    `json:"customApiUrl"`
        CustomModelName string    `json:"customModelName"`
        CreatedAt       time.Time `json:"created_at"`
        UpdatedAt       time.Time `json:"updated_at"`
}

// ExchangeConfig 交易所配置
type ExchangeConfig struct {
        ID        string `json:"id"`
        UserID    string `json:"user_id"`
        Name      string `json:"name"`
        Type      string `json:"type"`
        Enabled   bool   `json:"enabled"`
        APIKey    string `json:"apiKey"`
        SecretKey string `json:"secretKey"`
        Testnet   bool   `json:"testnet"`
        // Hyperliquid 特定字段
        HyperliquidWalletAddr string `json:"hyperliquidWalletAddr"`
        // Aster 特定字段
        AsterUser       string    `json:"asterUser"`
        AsterSigner     string    `json:"asterSigner"`
        AsterPrivateKey string    `json:"asterPrivateKey"`
        // OKX 特定字段
        OKXPassphrase   string    `json:"okxPassphrase"`
        CreatedAt       time.Time `json:"created_at"`
        UpdatedAt       time.Time `json:"updated_at"`
}

// TraderRecord 交易员配置（数据库实体）
type TraderRecord struct {
        ID                   string    `json:"id"`
        UserID               string    `json:"user_id"`
        Name                 string    `json:"name"`
        AIModelID            string    `json:"ai_model_id"`
        ExchangeID           string    `json:"exchange_id"`
        InitialBalance       float64   `json:"initial_balance"`
        ScanIntervalMinutes  int       `json:"scan_interval_minutes"`
        IsRunning            bool      `json:"is_running"`
        BTCETHLeverage       int       `json:"btc_eth_leverage"`       // BTC/ETH杠杆倍数
        AltcoinLeverage      int       `json:"altcoin_leverage"`       // 山寨币杠杆倍数
        TradingSymbols       string    `json:"trading_symbols"`        // 交易币种，逗号分隔
        UseCoinPool          bool      `json:"use_coin_pool"`          // 是否使用COIN POOL信号源
        UseOITop             bool      `json:"use_oi_top"`             // 是否使用OI TOP信号源
        CustomPrompt         string    `json:"custom_prompt"`          // 自定义交易策略prompt
        OverrideBasePrompt   bool      `json:"override_base_prompt"`   // 是否覆盖基础prompt
        SystemPromptTemplate string    `json:"system_prompt_template"` // 系统提示词模板名称
        IsCrossMargin        bool      `json:"is_cross_margin"`        // 是否为全仓模式（true=全仓，false=逐仓）
        CreatedAt            time.Time `json:"created_at"`
        UpdatedAt            time.Time `json:"updated_at"`
}

// UserSignalSource 用户信号源配置
type UserSignalSource struct {
        ID          int       `json:"id"`
        UserID      string    `json:"user_id"`
        CoinPoolURL string    `json:"coin_pool_url"`
        OITopURL    string    `json:"oi_top_url"`
        CreatedAt   time.Time `json:"created_at"`
        UpdatedAt   time.Time `json:"updated_at"`
}

// GenerateOTPSecret 生成OTP密钥
func GenerateOTPSecret() (string, error) <span class="cov0" title="0">{
        secret := make([]byte, 20)
        _, err := rand.Read(secret)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>
        <span class="cov0" title="0">return base32.StdEncoding.EncodeToString(secret), nil</span>
}

// CreateUser 创建用户（带重试逻辑，处理Neon冷启动）
func (d *Database) CreateUser(user *User) error <span class="cov0" title="0">{
        // 处理可空时间字段
        var lockedUntil, lastFailedAt sql.NullTime
        if user.LockedUntil != nil </span><span class="cov0" title="0">{
                lockedUntil = sql.NullTime{Time: *user.LockedUntil, Valid: true}
        }</span>
        <span class="cov0" title="0">if user.LastFailedAt != nil </span><span class="cov0" title="0">{
                lastFailedAt = sql.NullTime{Time: *user.LastFailedAt, Valid: true}
        }</span>

        // 使用 withRetry 处理 Neon 冷启动问题
        <span class="cov0" title="0">_, err := withRetry(func() (bool, error) </span><span class="cov0" title="0">{
                _, execErr := d.exec(`
                        INSERT INTO users (id, email, password_hash, otp_secret, otp_verified,
                                           locked_until, failed_attempts, last_failed_at,
                                           is_active, is_admin, beta_code, created_at, updated_at)
                        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)
                `, user.ID, user.Email, user.PasswordHash, user.OTPSecret, user.OTPVerified,
                        lockedUntil, user.FailedAttempts, lastFailedAt,
                        user.IsActive, user.IsAdmin, user.BetaCode, user.CreatedAt, user.UpdatedAt)
                return true, execErr
        }</span>)
        <span class="cov0" title="0">return err</span>
}

// EnsureDefaultUser 确保default系统用户存在（用于存储系统级别配置）
func (d *Database) EnsureDefaultUser() error <span class="cov0" title="0">{
        // 检查default用户是否已存在
        var count int
        err := d.queryRow(`SELECT COUNT(*) FROM users WHERE id = 'default'`).Scan(&amp;count)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        // 如果已存在，直接返回
        <span class="cov0" title="0">if count &gt; 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        // 创建default用户（系统级别用户，用于存储系统默认配置）
        <span class="cov0" title="0">now := time.Now()
        defaultUser := &amp;User{
                ID:             "default",
                Email:          "default@system",
                PasswordHash:   "", // 系统用户不需要密码
                OTPSecret:      "",
                OTPVerified:    true,
                IsActive:       true,
                IsAdmin:        false, // 不是管理员，只是系统用户
                FailedAttempts: 0,
                CreatedAt:      now,
                UpdatedAt:      now,
        }

        log.Println("📝 创建default系统用户（用于存储系统级别配置）...")
        return d.CreateUser(defaultUser)</span>
}

// EnsureAdminUser 确保admin用户存在（用于管理员模式）
func (d *Database) EnsureAdminUser() error <span class="cov0" title="0">{
        // 检查admin用户是否已存在
        var count int
        err := d.queryRow(`SELECT COUNT(*) FROM users WHERE id = 'admin'`).Scan(&amp;count)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        // 如果已存在，直接返回
        <span class="cov0" title="0">if count &gt; 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        // 创建admin用户（密码为空，因为管理员模式下不需要密码）
        <span class="cov0" title="0">now := time.Now()
        adminUser := &amp;User{
                ID:             "admin",
                Email:          "admin@localhost",
                PasswordHash:   "", // 管理员模式下不使用密码
                OTPSecret:      "",
                OTPVerified:    true,
                IsActive:       true,
                IsAdmin:        true,
                FailedAttempts: 0,
                CreatedAt:      now,
                UpdatedAt:      now,
        }

        return d.CreateUser(adminUser)</span>
}

// GetUserByEmail 通过邮箱获取用户（带重试逻辑，处理Neon冷启动）
func (d *Database) GetUserByEmail(email string) (*User, error) <span class="cov0" title="0">{
        return withRetry(func() (*User, error) </span><span class="cov0" title="0">{
                var user User
                var lockedUntil, lastFailedAt sql.NullTime
                err := d.queryRow(`
                        SELECT id, email, password_hash, otp_secret, otp_verified,
                               locked_until, failed_attempts, last_failed_at,
                               is_active, is_admin, beta_code,
                               created_at, updated_at
                        FROM users WHERE email = ?
                `, email).Scan(
                        &amp;user.ID, &amp;user.Email, &amp;user.PasswordHash, &amp;user.OTPSecret, &amp;user.OTPVerified,
                        &amp;lockedUntil, &amp;user.FailedAttempts, &amp;lastFailedAt,
                        &amp;user.IsActive, &amp;user.IsAdmin, &amp;user.BetaCode,
                        &amp;user.CreatedAt, &amp;user.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">if lockedUntil.Valid </span><span class="cov0" title="0">{
                        user.LockedUntil = &amp;lockedUntil.Time
                }</span>
                <span class="cov0" title="0">if lastFailedAt.Valid </span><span class="cov0" title="0">{
                        user.LastFailedAt = &amp;lastFailedAt.Time
                }</span>
                <span class="cov0" title="0">return &amp;user, nil</span>
        })
}

// GetUserByID 通过ID获取用户
func (d *Database) GetUserByID(userID string) (*User, error) <span class="cov0" title="0">{
        return withRetry(func() (*User, error) </span><span class="cov0" title="0">{
                var user User
                var lockedUntil, lastFailedAt sql.NullTime
                err := d.queryRow(`
                        SELECT id, email, password_hash, otp_secret, otp_verified,
                               locked_until, failed_attempts, last_failed_at,
                               is_active, is_admin, beta_code,
                               created_at, updated_at
                        FROM users WHERE id = ?
                `, userID).Scan(
                        &amp;user.ID, &amp;user.Email, &amp;user.PasswordHash, &amp;user.OTPSecret, &amp;user.OTPVerified,
                        &amp;lockedUntil, &amp;user.FailedAttempts, &amp;lastFailedAt,
                        &amp;user.IsActive, &amp;user.IsAdmin, &amp;user.BetaCode,
                        &amp;user.CreatedAt, &amp;user.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">if lockedUntil.Valid </span><span class="cov0" title="0">{
                        user.LockedUntil = &amp;lockedUntil.Time
                }</span>
                <span class="cov0" title="0">if lastFailedAt.Valid </span><span class="cov0" title="0">{
                        user.LastFailedAt = &amp;lastFailedAt.Time
                }</span>
                <span class="cov0" title="0">return &amp;user, nil</span>
        })
}

// GetUsers 获取用户列表（分页、搜索、排序）
func (d *Database) GetUsers(page, limit int, search, sort, order string) ([]*User, int, error) <span class="cov0" title="0">{
        // 参数验证
        if limit &gt; 100 </span><span class="cov0" title="0">{
                limit = 100
        }</span>
        <span class="cov0" title="0">if page &lt; 1 </span><span class="cov0" title="0">{
                page = 1
        }</span>

        // 计算偏移量
        <span class="cov0" title="0">offset := (page - 1) * limit

        // 验证排序字段
        validSortFields := map[string]bool{
                "created_at": true,
                "email":      true,
        }
        if !validSortFields[sort] </span><span class="cov0" title="0">{
                sort = "created_at"
        }</span>

        // 验证排序方向
        <span class="cov0" title="0">if order != "asc" &amp;&amp; order != "desc" </span><span class="cov0" title="0">{
                order = "desc"
        }</span>

        // 构建SQL查询
        <span class="cov0" title="0">var args []interface{}
        sql := `
                SELECT id, email, is_active, is_admin, otp_verified,
                       created_at, updated_at
                FROM users
        `

        // 添加搜索条件
        if search != "" </span><span class="cov0" title="0">{
                sql += " WHERE email LIKE ?"
                args = append(args, "%"+search+"%")
        }</span>

        // 添加排序
        <span class="cov0" title="0">sql += fmt.Sprintf(" ORDER BY %s %s", sort, order)

        // 添加分页
        sql += " LIMIT ? OFFSET ?"
        args = append(args, limit, offset)

        // 执行查询
        rows, err := d.query(sql, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, 0, fmt.Errorf("查询用户列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        // 处理结果
        var users []*User
        for rows.Next() </span><span class="cov0" title="0">{
                user := &amp;User{}
                err := rows.Scan(
                        &amp;user.ID,
                        &amp;user.Email,
                        &amp;user.IsActive,
                        &amp;user.IsAdmin,
                        &amp;user.OTPVerified,
                        &amp;user.CreatedAt,
                        &amp;user.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, 0, fmt.Errorf("扫描用户数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">users = append(users, user)</span>
        }

        // 获取总数
        <span class="cov0" title="0">total, err := d.GetUserCount(search)
        if err != nil </span><span class="cov0" title="0">{
                return nil, 0, fmt.Errorf("获取用户总数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return users, total, nil</span>
}

// GetUserCount 获取用户总数
func (d *Database) GetUserCount(search string) (int, error) <span class="cov0" title="0">{
        var count int
        sql := "SELECT COUNT(*) FROM users"

        // 添加搜索条件
        if search != "" </span><span class="cov0" title="0">{
                sql += " WHERE email LIKE ?"
                row := d.queryRow(sql, "%"+search+"%")
                err := row.Scan(&amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return 0, fmt.Errorf("获取用户总数失败: %w", err)
                }</span>
        } else<span class="cov0" title="0"> {
                row := d.queryRow(sql)
                err := row.Scan(&amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return 0, fmt.Errorf("获取用户总数失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return count, nil</span>
}

// GetAllUsers 获取所有用户ID列表
func (d *Database) GetAllUsers() ([]string, error) <span class="cov0" title="0">{
        rows, err := d.query(`SELECT id FROM users ORDER BY id`)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var userIDs []string
        for rows.Next() </span><span class="cov0" title="0">{
                var userID string
                if err := rows.Scan(&amp;userID); err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">userIDs = append(userIDs, userID)</span>
        }
        <span class="cov0" title="0">return userIDs, nil</span>
}

// UpdateUserOTPVerified 更新用户OTP验证状态
func (d *Database) UpdateUserOTPVerified(userID string, verified bool) error <span class="cov0" title="0">{
        _, err := d.exec(`UPDATE users SET otp_verified = ? WHERE id = ?`, verified, userID)
        return err
}</span>

// GetAIModels 获取用户的AI模型配置
func (d *Database) GetAIModels(userID string) ([]*AIModelConfig, error) <span class="cov0" title="0">{
        return withRetry(func() ([]*AIModelConfig, error) </span><span class="cov0" title="0">{
                rows, err := d.query(`
                        SELECT id, user_id, name, provider, enabled, api_key,
                               COALESCE(custom_api_url, '') as custom_api_url,
                               COALESCE(custom_model_name, '') as custom_model_name,
                               created_at, updated_at
                        FROM ai_models WHERE user_id = ? ORDER BY id
                `, userID)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">defer rows.Close()

                // 初始化为空切片而不是nil，确保JSON序列化为[]而不是null
                models := make([]*AIModelConfig, 0)
                for rows.Next() </span><span class="cov0" title="0">{
                        var model AIModelConfig
                        err := rows.Scan(
                                &amp;model.ID, &amp;model.UserID, &amp;model.Name, &amp;model.Provider,
                                &amp;model.Enabled, &amp;model.APIKey, &amp;model.CustomAPIURL, &amp;model.CustomModelName,
                                &amp;model.CreatedAt, &amp;model.UpdatedAt,
                        )
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov0" title="0">models = append(models, &amp;model)</span>
                }

                <span class="cov0" title="0">return models, nil</span>
        })
}

// UpdateAIModel 更新AI模型配置，如果不存在则创建用户特定配置
func (d *Database) UpdateAIModel(userID, id string, enabled bool, apiKey, customAPIURL, customModelName string) error <span class="cov0" title="0">{
        // 先尝试精确匹配 ID（新版逻辑，支持多个相同 provider 的模型）
        var existingID string
        err := d.queryRow(`
                SELECT id FROM ai_models WHERE user_id = $1 AND id = $2 LIMIT 1
        `, userID, id).Scan(&amp;existingID)

        if err == nil </span><span class="cov0" title="0">{
                // 找到了现有配置（精确匹配 ID），更新它
                _, err = d.exec(`
                        UPDATE ai_models SET enabled = $1, api_key = $2, custom_api_url = $3, custom_model_name = $4, updated_at = CURRENT_TIMESTAMP
                        WHERE id = $5 AND user_id = $6
                `, enabled, apiKey, customAPIURL, customModelName, existingID, userID)
                return err
        }</span>

        // ID 不存在，尝试兼容旧逻辑：将 id 作为 provider 查找
        <span class="cov0" title="0">provider := id
        err = d.queryRow(`
                SELECT id FROM ai_models WHERE user_id = $1 AND provider = $2 LIMIT 1
        `, userID, provider).Scan(&amp;existingID)

        if err == nil </span><span class="cov0" title="0">{
                // 找到了现有配置（通过 provider 匹配，兼容旧版），更新它
                log.Printf("⚠️  使用旧版 provider 匹配更新模型: %s -&gt; %s", provider, existingID)
                _, err = d.exec(`
                        UPDATE ai_models SET enabled = $1, api_key = $2, custom_api_url = $3, custom_model_name = $4, updated_at = CURRENT_TIMESTAMP
                        WHERE id = $5 AND user_id = $6
                `, enabled, apiKey, customAPIURL, customModelName, existingID, userID)
                return err
        }</span>

        // 没有找到任何现有配置，创建新的
        // 推断 provider（从 id 中提取，或者直接使用 id）
        <span class="cov0" title="0">if provider == id &amp;&amp; (provider == "deepseek" || provider == "qwen") </span><span class="cov0" title="0">{
                // id 本身就是 provider
                provider = id
        }</span> else<span class="cov0" title="0"> {
                // 从 id 中提取 provider（假设格式是 userID_provider 或 timestamp_userID_provider）
                parts := strings.Split(id, "_")
                if len(parts) &gt;= 2 </span><span class="cov0" title="0">{
                        provider = parts[len(parts)-1] // 取最后一部分作为 provider
                }</span> else<span class="cov0" title="0"> {
                        provider = id
                }</span>
        }

        // 获取模型的基本信息
        <span class="cov0" title="0">var name string
        err = d.queryRow(`
                SELECT name FROM ai_models WHERE provider = $1 LIMIT 1
        `, provider).Scan(&amp;name)
        if err != nil </span><span class="cov0" title="0">{
                // 如果找不到基本信息，使用默认值
                if provider == "deepseek" </span><span class="cov0" title="0">{
                        name = "DeepSeek AI"
                }</span> else<span class="cov0" title="0"> if provider == "qwen" </span><span class="cov0" title="0">{
                        name = "Qwen AI"
                }</span> else<span class="cov0" title="0"> {
                        name = provider + " AI"
                }</span>
        }

        // 如果传入的 ID 已经是完整格式（如 "admin_deepseek_custom1"），直接使用
        // 否则生成新的 ID
        <span class="cov0" title="0">newModelID := id
        if id == provider </span><span class="cov0" title="0">{
                // id 就是 provider，生成新的用户特定 ID
                newModelID = fmt.Sprintf("%s_%s", userID, provider)
        }</span>

        <span class="cov0" title="0">log.Printf("✓ 创建新的 AI 模型配置: ID=%s, Provider=%s, Name=%s", newModelID, provider, name)
        _, err = d.exec(`
                INSERT INTO ai_models (id, user_id, name, provider, enabled, api_key, custom_api_url, custom_model_name)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        `, newModelID, userID, name, provider, enabled, apiKey, customAPIURL, customModelName)

        return err</span>
}

// GetExchanges 获取用户的交易所配置
func (d *Database) GetExchanges(userID string) ([]*ExchangeConfig, error) <span class="cov0" title="0">{
        return withRetry(func() ([]*ExchangeConfig, error) </span><span class="cov0" title="0">{
                rows, err := d.query(`
                        SELECT id, user_id, name, type, enabled, api_key, secret_key, testnet,
                               COALESCE(hyperliquid_wallet_addr, '') as hyperliquid_wallet_addr,
                               COALESCE(aster_user, '') as aster_user,
                               COALESCE(aster_signer, '') as aster_signer,
                               COALESCE(aster_private_key, '') as aster_private_key,
                               COALESCE(okx_passphrase, '') as okx_passphrase,
                               created_at, updated_at
                        FROM exchanges WHERE user_id = ? ORDER BY id
                `, userID)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">defer rows.Close()

                // 初始化为空切片而不是nil，确保JSON序列化为[]而不是null
                exchanges := make([]*ExchangeConfig, 0)
                for rows.Next() </span><span class="cov0" title="0">{
                        var exchange ExchangeConfig
                        err := rows.Scan(
                                &amp;exchange.ID, &amp;exchange.UserID, &amp;exchange.Name, &amp;exchange.Type,
                                &amp;exchange.Enabled, &amp;exchange.APIKey, &amp;exchange.SecretKey, &amp;exchange.Testnet,
                                &amp;exchange.HyperliquidWalletAddr, &amp;exchange.AsterUser,
                                &amp;exchange.AsterSigner, &amp;exchange.AsterPrivateKey,
                                &amp;exchange.OKXPassphrase,
                                &amp;exchange.CreatedAt, &amp;exchange.UpdatedAt,
                        )
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov0" title="0">exchanges = append(exchanges, &amp;exchange)</span>
                }

                <span class="cov0" title="0">return exchanges, nil</span>
        })
}

// UpdateExchange 更新交易所配置，如果不存在则创建用户特定配置
func (d *Database) UpdateExchange(userID, id string, enabled bool, apiKey, secretKey string, testnet bool, hyperliquidWalletAddr, asterUser, asterSigner, asterPrivateKey, okxPassphrase string) error <span class="cov0" title="0">{
        log.Printf("🔧 UpdateExchange: userID=%s, id=%s, enabled=%v", userID, id, enabled)

        // 首先尝试更新现有的用户配置
        result, err := d.exec(`
                UPDATE exchanges SET enabled = $1, api_key = $2, secret_key = $3, testnet = $4,
                       hyperliquid_wallet_addr = $5, aster_user = $6, aster_signer = $7, aster_private_key = $8, okx_passphrase = $9, updated_at = CURRENT_TIMESTAMP
                WHERE id = $10 AND user_id = $11
        `, enabled, apiKey, secretKey, testnet, hyperliquidWalletAddr, asterUser, asterSigner, asterPrivateKey, okxPassphrase, id, userID)
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("❌ UpdateExchange: 更新失败: %v", err)
                return err
        }</span>

        // 检查是否有行被更新
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("❌ UpdateExchange: 获取影响行数失败: %v", err)
                return err
        }</span>

        <span class="cov0" title="0">log.Printf("📊 UpdateExchange: 影响行数 = %d", rowsAffected)

        // 如果没有行被更新，说明用户没有这个交易所的配置，需要创建
        if rowsAffected == 0 </span><span class="cov0" title="0">{
                log.Printf("💡 UpdateExchange: 没有现有记录，创建新记录")

                // 根据交易所ID确定基本信息
                var name, typ string
                if id == "binance" </span><span class="cov0" title="0">{
                        name = "Binance Futures"
                        typ = "cex"
                }</span> else<span class="cov0" title="0"> if id == "hyperliquid" </span><span class="cov0" title="0">{
                        name = "Hyperliquid"
                        typ = "dex"
                }</span> else<span class="cov0" title="0"> if id == "aster" </span><span class="cov0" title="0">{
                        name = "Aster DEX"
                        typ = "dex"
                }</span> else<span class="cov0" title="0"> if id == "okx" </span><span class="cov0" title="0">{
                        name = "OKX Futures"
                        typ = "cex"
                }</span> else<span class="cov0" title="0"> {
                        name = id + " Exchange"
                        typ = "cex"
                }</span>

                <span class="cov0" title="0">log.Printf("🆕 UpdateExchange: 创建新记录 ID=%s, name=%s, type=%s", id, name, typ)

                // 创建用户特定的配置，使用ON CONFLICT处理冲突
                _, err = d.exec(`
                        INSERT INTO exchanges (id, user_id, name, type, enabled, api_key, secret_key, testnet,
                                               hyperliquid_wallet_addr, aster_user, aster_signer, aster_private_key, okx_passphrase)
                        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)
                        ON CONFLICT (id, user_id) DO UPDATE SET
                                enabled = EXCLUDED.enabled,
                                api_key = EXCLUDED.api_key,
                                secret_key = EXCLUDED.secret_key,
                                testnet = EXCLUDED.testnet,
                                hyperliquid_wallet_addr = EXCLUDED.hyperliquid_wallet_addr,
                                aster_user = EXCLUDED.aster_user,
                                aster_signer = EXCLUDED.aster_signer,
                                aster_private_key = EXCLUDED.aster_private_key,
                                okx_passphrase = EXCLUDED.okx_passphrase,
                                updated_at = CURRENT_TIMESTAMP
                `, id, userID, name, typ, enabled, apiKey, secretKey, testnet, hyperliquidWalletAddr, asterUser, asterSigner, asterPrivateKey, okxPassphrase)

                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("❌ UpdateExchange: 创建记录失败: %v", err)
                }</span> else<span class="cov0" title="0"> {
                        log.Printf("✅ UpdateExchange: 创建记录成功")
                }</span>
                <span class="cov0" title="0">return err</span>
        }

        <span class="cov0" title="0">log.Printf("✅ UpdateExchange: 更新现有记录成功")
        return nil</span>
}

// CreateAIModel 创建AI模型配置
func (d *Database) CreateAIModel(userID, id, name, provider string, enabled bool, apiKey, customAPIURL string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO ai_models (id, user_id, name, provider, enabled, api_key, custom_api_url)
                VALUES ($1, $2, $3, $4, $5, $6, $7)
                ON CONFLICT (id) DO NOTHING
        `, id, userID, name, provider, enabled, apiKey, customAPIURL)
        return err
}</span>

// CreateExchange 创建交易所配置
func (d *Database) CreateExchange(userID, id, name, typ string, enabled bool, apiKey, secretKey string, testnet bool, hyperliquidWalletAddr, asterUser, asterSigner, asterPrivateKey string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO exchanges (id, user_id, name, type, enabled, api_key, secret_key, testnet, hyperliquid_wallet_addr, aster_user, aster_signer, aster_private_key)
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
                ON CONFLICT (id) DO NOTHING
        `, id, userID, name, typ, enabled, apiKey, secretKey, testnet, hyperliquidWalletAddr, asterUser, asterSigner, asterPrivateKey)
        return err
}</span>

// CreateTrader 创建交易员
func (d *Database) CreateTrader(trader *TraderRecord) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO traders (id, user_id, name, ai_model_id, exchange_id, initial_balance, scan_interval_minutes, is_running, btc_eth_leverage, altcoin_leverage, trading_symbols, use_coin_pool, use_oi_top, custom_prompt, override_base_prompt, system_prompt_template, is_cross_margin)
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17)
        `, trader.ID, trader.UserID, trader.Name, trader.AIModelID, trader.ExchangeID, trader.InitialBalance, trader.ScanIntervalMinutes, trader.IsRunning, trader.BTCETHLeverage, trader.AltcoinLeverage, trader.TradingSymbols, trader.UseCoinPool, trader.UseOITop, trader.CustomPrompt, trader.OverrideBasePrompt, trader.SystemPromptTemplate, trader.IsCrossMargin)
        return err
}</span>

// GetTraders 获取用户的交易员
func (d *Database) GetTraders(userID string) ([]*TraderRecord, error) <span class="cov0" title="0">{
        return withRetry(func() ([]*TraderRecord, error) </span><span class="cov0" title="0">{
                rows, err := d.query(`
                        SELECT id, user_id, name, ai_model_id, exchange_id, initial_balance, scan_interval_minutes, is_running,
                               COALESCE(btc_eth_leverage, 5) as btc_eth_leverage, COALESCE(altcoin_leverage, 5) as altcoin_leverage,
                               COALESCE(trading_symbols, '') as trading_symbols,
                               COALESCE(use_coin_pool, false) as use_coin_pool, COALESCE(use_oi_top, false) as use_oi_top,
                               COALESCE(custom_prompt, '') as custom_prompt, COALESCE(override_base_prompt, false) as override_base_prompt,
                               COALESCE(system_prompt_template, 'default') as system_prompt_template,
                               COALESCE(is_cross_margin, true) as is_cross_margin, created_at, updated_at
                        FROM traders WHERE user_id = ? ORDER BY created_at DESC
                `, userID)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">defer rows.Close()

                var traders []*TraderRecord
                for rows.Next() </span><span class="cov0" title="0">{
                        var trader TraderRecord
                        err := rows.Scan(
                                &amp;trader.ID, &amp;trader.UserID, &amp;trader.Name, &amp;trader.AIModelID, &amp;trader.ExchangeID,
                                &amp;trader.InitialBalance, &amp;trader.ScanIntervalMinutes, &amp;trader.IsRunning,
                                &amp;trader.BTCETHLeverage, &amp;trader.AltcoinLeverage, &amp;trader.TradingSymbols,
                                &amp;trader.UseCoinPool, &amp;trader.UseOITop,
                                &amp;trader.CustomPrompt, &amp;trader.OverrideBasePrompt, &amp;trader.SystemPromptTemplate,
                                &amp;trader.IsCrossMargin,
                                &amp;trader.CreatedAt, &amp;trader.UpdatedAt,
                        )
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, err
                        }</span>
                        <span class="cov0" title="0">traders = append(traders, &amp;trader)</span>
                }

                <span class="cov0" title="0">return traders, nil</span>
        })
}

// UpdateTraderStatus 更新交易员状态
func (d *Database) UpdateTraderStatus(userID, id string, isRunning bool) error <span class="cov0" title="0">{
        _, err := d.exec(`UPDATE traders SET is_running = ? WHERE id = ? AND user_id = ?`, isRunning, id, userID)
        return err
}</span>

// UpdateTrader 更新交易员配置
func (d *Database) UpdateTrader(trader *TraderRecord) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE traders SET
                        name = ?, ai_model_id = ?, exchange_id = ?, initial_balance = ?,
                        scan_interval_minutes = ?, btc_eth_leverage = ?, altcoin_leverage = ?,
                        trading_symbols = ?, custom_prompt = ?, override_base_prompt = ?,
                        system_prompt_template = ?, is_cross_margin = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ? AND user_id = ?
        `, trader.Name, trader.AIModelID, trader.ExchangeID, trader.InitialBalance,
                trader.ScanIntervalMinutes, trader.BTCETHLeverage, trader.AltcoinLeverage,
                trader.TradingSymbols, trader.CustomPrompt, trader.OverrideBasePrompt,
                trader.SystemPromptTemplate, trader.IsCrossMargin, trader.ID, trader.UserID)
        return err
}</span>

// UpdateTraderCustomPrompt 更新交易员自定义Prompt
func (d *Database) UpdateTraderCustomPrompt(userID, id string, customPrompt string, overrideBase bool) error <span class="cov0" title="0">{
        _, err := d.exec(`UPDATE traders SET custom_prompt = ?, override_base_prompt = ? WHERE id = ? AND user_id = ?`, customPrompt, overrideBase, id, userID)
        return err
}</span>

// DeleteTrader 删除交易员
func (d *Database) DeleteTrader(userID, id string) error <span class="cov0" title="0">{
        _, err := d.exec(`DELETE FROM traders WHERE id = ? AND user_id = ?`, id, userID)
        return err
}</span>

// traderConfigResult 用于 withRetry 的返回结构
type traderConfigResult struct {
        trader   *TraderRecord
        aiModel  *AIModelConfig
        exchange *ExchangeConfig
}

// GetTraderConfig 获取交易员完整配置（包含AI模型和交易所信息）
func (d *Database) GetTraderConfig(userID, traderID string) (*TraderRecord, *AIModelConfig, *ExchangeConfig, error) <span class="cov0" title="0">{
        result, err := withRetry(func() (*traderConfigResult, error) </span><span class="cov0" title="0">{
                var trader TraderRecord
                var aiModel AIModelConfig
                var exchange ExchangeConfig

                err := d.queryRow(`
                        SELECT 
                                t.id, t.user_id, t.name, t.ai_model_id, t.exchange_id, t.initial_balance, t.scan_interval_minutes, t.is_running, t.created_at, t.updated_at,
                                a.id, a.user_id, a.name, a.provider, a.enabled, a.api_key, a.created_at, a.updated_at,
                                e.id, e.user_id, e.name, e.type, e.enabled, e.api_key, e.secret_key, e.testnet,
                                COALESCE(e.hyperliquid_wallet_addr, '') as hyperliquid_wallet_addr,
                                COALESCE(e.aster_user, '') as aster_user,
                                COALESCE(e.aster_signer, '') as aster_signer,
                                COALESCE(e.aster_private_key, '') as aster_private_key,
                                e.created_at, e.updated_at
                        FROM traders t
                        JOIN ai_models a ON t.ai_model_id = a.id AND t.user_id = a.user_id
                        JOIN exchanges e ON t.exchange_id = e.id AND t.user_id = e.user_id
                        WHERE t.id = ? AND t.user_id = ?
                `, traderID, userID).Scan(
                        &amp;trader.ID, &amp;trader.UserID, &amp;trader.Name, &amp;trader.AIModelID, &amp;trader.ExchangeID,
                        &amp;trader.InitialBalance, &amp;trader.ScanIntervalMinutes, &amp;trader.IsRunning,
                        &amp;trader.CreatedAt, &amp;trader.UpdatedAt,
                        &amp;aiModel.ID, &amp;aiModel.UserID, &amp;aiModel.Name, &amp;aiModel.Provider, &amp;aiModel.Enabled, &amp;aiModel.APIKey,
                        &amp;aiModel.CreatedAt, &amp;aiModel.UpdatedAt,
                        &amp;exchange.ID, &amp;exchange.UserID, &amp;exchange.Name, &amp;exchange.Type, &amp;exchange.Enabled,
                        &amp;exchange.APIKey, &amp;exchange.SecretKey, &amp;exchange.Testnet,
                        &amp;exchange.HyperliquidWalletAddr, &amp;exchange.AsterUser, &amp;exchange.AsterSigner, &amp;exchange.AsterPrivateKey,
                        &amp;exchange.CreatedAt, &amp;exchange.UpdatedAt,
                )

                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>

                <span class="cov0" title="0">return &amp;traderConfigResult{
                        trader:   &amp;trader,
                        aiModel:  &amp;aiModel,
                        exchange: &amp;exchange,
                }, nil</span>
        })

        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                return nil, nil, nil, err
        }</span>

        <span class="cov0" title="0">return result.trader, result.aiModel, result.exchange, nil</span>
}

// GetSystemConfig 获取系统配置
func (d *Database) GetSystemConfig(key string) (string, error) <span class="cov0" title="0">{
        return withRetry(func() (string, error) </span><span class="cov0" title="0">{
                var value string
                err := d.queryRow(`SELECT value FROM system_config WHERE key = $1`, key).Scan(&amp;value)
                if err != nil </span><span class="cov0" title="0">{
                        if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                                // 如果 key 不存在，返回空字符串和 nil 错误
                                return "", nil
                        }</span>
                        <span class="cov0" title="0">return "", err</span>
                }
                <span class="cov0" title="0">return value, nil</span>
        })
}

// SetSystemConfig 设置系统配置
func (d *Database) SetSystemConfig(key, value string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO system_config (key, value) VALUES ($1, $2)
                ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value, updated_at = CURRENT_TIMESTAMP
        `, key, value)
        return err
}</span>

// CreateUserSignalSource 创建用户信号源配置
func (d *Database) CreateUserSignalSource(userID, coinPoolURL, oiTopURL string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO user_signal_sources (user_id, coin_pool_url, oi_top_url, updated_at)
                VALUES ($1, $2, $3, CURRENT_TIMESTAMP)
                ON CONFLICT (user_id) DO UPDATE SET coin_pool_url = EXCLUDED.coin_pool_url, oi_top_url = EXCLUDED.oi_top_url, updated_at = CURRENT_TIMESTAMP
        `, userID, coinPoolURL, oiTopURL)
        return err
}</span>

// GetUserSignalSource 获取用户信号源配置
func (d *Database) GetUserSignalSource(userID string) (*UserSignalSource, error) <span class="cov0" title="0">{
        var source UserSignalSource
        err := d.queryRow(`
                SELECT id, user_id, coin_pool_url, oi_top_url, created_at, updated_at
                FROM user_signal_sources WHERE user_id = $1
        `, userID).Scan(
                &amp;source.ID, &amp;source.UserID, &amp;source.CoinPoolURL, &amp;source.OITopURL,
                &amp;source.CreatedAt, &amp;source.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">return &amp;source, nil</span>
}

// UpdateUserSignalSource 更新用户信号源配置
func (d *Database) UpdateUserSignalSource(userID, coinPoolURL, oiTopURL string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE user_signal_sources SET coin_pool_url = ?, oi_top_url = ?, updated_at = CURRENT_TIMESTAMP
                WHERE user_id = ?
        `, coinPoolURL, oiTopURL, userID)
        return err
}</span>

// GetCustomCoins 获取所有交易员自定义币种 / Get all trader-customized currencies
func (d *Database) GetCustomCoins() []string <span class="cov0" title="0">{
        var symbol string
        var symbols []string
        _ = d.queryRow(`
                SELECT GROUP_CONCAT(custom_coins , ',') as symbol
                FROM main.traders where custom_coins != ''
        `).Scan(&amp;symbol)
        // 检测用户是否未配置币种 - 兼容性
        if symbol == "" </span><span class="cov0" title="0">{
                symbolJSON, _ := d.GetSystemConfig("default_coins")
                if err := json.Unmarshal([]byte(symbolJSON), &amp;symbols); err != nil </span><span class="cov0" title="0">{
                        log.Printf("⚠️  解析default_coins配置失败: %v，使用硬编码默认值", err)
                        symbols = []string{"BTCUSDT", "ETHUSDT", "SOLUSDT", "BNBUSDT"}
                }</span>
        }
        // filter Symbol
        <span class="cov0" title="0">for _, s := range strings.Split(symbol, ",") </span><span class="cov0" title="0">{
                if s == "" </span><span class="cov0" title="0">{
                        continue</span>
                }
                <span class="cov0" title="0">coin := market.Normalize(s)
                if !slices.Contains(symbols, coin) </span><span class="cov0" title="0">{
                        symbols = append(symbols, coin)
                }</span>
        }
        <span class="cov0" title="0">return symbols</span>
}

// Close 关闭数据库连接
func (d *Database) Close() error <span class="cov0" title="0">{
        return d.db.Close()
}</span>

// LoadBetaCodesFromFile 从文件加载内测码到数据库
func (d *Database) LoadBetaCodesFromFile(filePath string) error <span class="cov0" title="0">{
        // 读取文件内容
        content, err := os.ReadFile(filePath)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("读取内测码文件失败: %w", err)
        }</span>

        // 按行分割内测码
        <span class="cov0" title="0">lines := strings.Split(string(content), "\n")
        var codes []string
        for _, line := range lines </span><span class="cov0" title="0">{
                code := strings.TrimSpace(line)
                if code != "" &amp;&amp; !strings.HasPrefix(code, "#") </span><span class="cov0" title="0">{
                        codes = append(codes, code)
                }</span>
        }

        // 批量插入内测码
        <span class="cov0" title="0">tx, err := d.db.Begin()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        stmt, err := tx.Prepare(`INSERT INTO beta_codes (code) VALUES ($1) ON CONFLICT (code) DO NOTHING`)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("准备语句失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer stmt.Close()

        insertedCount := 0
        for _, code := range codes </span><span class="cov0" title="0">{
                result, err := stmt.Exec(code)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("插入内测码 %s 失败: %v", code, err)
                        continue</span>
                }
                
                <span class="cov0" title="0">if rowsAffected, _ := result.RowsAffected(); rowsAffected &gt; 0 </span><span class="cov0" title="0">{
                        insertedCount++
                }</span>
        }

        <span class="cov0" title="0">if err := tx.Commit(); err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("提交事务失败: %w", err)
        }</span>

        <span class="cov0" title="0">log.Printf("✅ 成功加载 %d 个内测码到数据库 (总计 %d 个)", insertedCount, len(codes))
        return nil</span>
}

// ValidateBetaCode 验证内测码是否有效且未使用
func (d *Database) ValidateBetaCode(code string) (bool, error) <span class="cov0" title="0">{
        var used bool
        err := d.queryRow(`SELECT used FROM beta_codes WHERE code = $1`, code).Scan(&amp;used)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return false, nil // 内测码不存在
                }</span>
                <span class="cov0" title="0">return false, err</span>
        }
        <span class="cov0" title="0">return !used, nil</span> // 内测码存在且未使用
}

// UseBetaCode 使用内测码（标记为已使用）
func (d *Database) UseBetaCode(code, userEmail string) error <span class="cov0" title="0">{
        result, err := d.exec(`
                UPDATE beta_codes SET used = 1, used_by = ?, used_at = CURRENT_TIMESTAMP 
                WHERE code = ? AND used = 0
        `, userEmail, code)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("内测码无效或已被使用")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetBetaCodeStats 获取内测码统计信息
func (d *Database) GetBetaCodeStats() (total, used int, err error) <span class="cov0" title="0">{
        err = d.queryRow(`SELECT COUNT(*) FROM beta_codes`).Scan(&amp;total)
        if err != nil </span><span class="cov0" title="0">{
                return 0, 0, err
        }</span>

        <span class="cov0" title="0">err = d.queryRow(`SELECT COUNT(*) FROM beta_codes WHERE used = 1`).Scan(&amp;used)
        if err != nil </span><span class="cov0" title="0">{
                return 0, 0, err
        }</span>

        <span class="cov0" title="0">return total, used, nil</span>
}

// UpdateUserPassword 更新用户密码
func (d *Database) UpdateUserPassword(userID, newPasswordHash string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE users SET password_hash = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
        `, newPasswordHash, userID)
        return err
}</span>

// UpdateUserLockoutStatus 更新用户锁定状态
func (d *Database) UpdateUserLockoutStatus(userID string, failedAttempts int, lockedUntil *time.Time) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE users SET failed_attempts = ?, locked_until = ?, last_failed_at = CURRENT_TIMESTAMP
                WHERE id = ?
        `, failedAttempts, lockedUntil, userID)
        return err
}</span>

// ResetUserFailedAttempts 重置用户失败尝试次数
func (d *Database) ResetUserFailedAttempts(userID string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE users SET failed_attempts = 0, locked_until = NULL, last_failed_at = NULL
                WHERE id = ?
        `, userID)
        return err
}</span>

// RecordLoginAttempt 记录登录尝试
func (d *Database) RecordLoginAttempt(userID *string, email, ipAddress, userAgent string, success bool) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO login_attempts (id, user_id, email, ip_address, success, user_agent)
                VALUES (?, ?, ?, ?, ?, ?)
        `, GenerateUUID(), userID, email, ipAddress, success, userAgent)
        return err
}</span>

// GetLoginAttemptsByIP 获取IP在过去15分钟内的失败尝试次数
func (d *Database) GetLoginAttemptsByIP(ipAddress string) (int, error) <span class="cov0" title="0">{
        var count int
        err := d.queryRow(`
                SELECT COUNT(*) FROM login_attempts
                WHERE ip_address = $1 AND success = 0 AND timestamp &gt; CURRENT_TIMESTAMP - INTERVAL '15 minutes'
        `, ipAddress).Scan(&amp;count)
        return count, err
}</span>

// GetLoginAttemptsByEmail 获取邮箱在过去15分钟内的失败尝试次数
func (d *Database) GetLoginAttemptsByEmail(email string) (int, error) <span class="cov0" title="0">{
        var count int
        err := d.queryRow(`
                SELECT COUNT(*) FROM login_attempts
                WHERE email = $1 AND success = 0 AND timestamp &gt; CURRENT_TIMESTAMP - INTERVAL '15 minutes'
        `, email).Scan(&amp;count)
        return count, err
}</span>

// CreatePasswordResetToken 创建密码重置令牌
func (d *Database) CreatePasswordResetToken(userID, token, tokenHash string, expiresAt time.Time) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO password_resets (id, user_id, token_hash, expires_at)
                VALUES (?, ?, ?, ?)
        `, token, userID, tokenHash, expiresAt)
        return err
}</span>

// ValidatePasswordResetToken 验证密码重置令牌
func (d *Database) ValidatePasswordResetToken(tokenHash string) (*string, error) <span class="cov0" title="0">{
        var userID string
        var expiresAt time.Time
        err := d.queryRow(`
                SELECT user_id, expires_at FROM password_resets
                WHERE token_hash = ? AND used_at IS NULL AND expires_at &gt; CURRENT_TIMESTAMP
        `, tokenHash).Scan(&amp;userID, &amp;expiresAt)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">return &amp;userID, nil</span>
}

// MarkPasswordResetTokenAsUsed 标记密码重置令牌为已使用
func (d *Database) MarkPasswordResetTokenAsUsed(tokenHash string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE password_resets SET used_at = CURRENT_TIMESTAMP
                WHERE token_hash = ?
        `, tokenHash)
        return err
}</span>

// InvalidateAllPasswordResetTokens 使用户的所有密码重置令牌失效
func (d *Database) InvalidateAllPasswordResetTokens(userID string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                UPDATE password_resets SET used_at = CURRENT_TIMESTAMP
                WHERE user_id = ? AND used_at IS NULL
        `, userID)
        return err
}</span>

// CreateAuditLog 创建审计日志
func (d *Database) CreateAuditLog(userID *string, action, ipAddress, userAgent string, success bool, details string) error <span class="cov0" title="0">{
        _, err := d.exec(`
                INSERT INTO audit_logs (id, user_id, action, ip_address, user_agent, success, details)
                VALUES (?, ?, ?, ?, ?, ?, ?)
        `, GenerateUUID(), userID, action, ipAddress, userAgent, success, details)
        return err
}</span>

// GetAuditLogs 获取用户的审计日志
func (d *Database) GetAuditLogs(userID string, limit int) ([]map[string]interface{}, error) <span class="cov0" title="0">{
        rows, err := d.query(`
                SELECT action, ip_address, success, details, created_at
                FROM audit_logs
                WHERE user_id = ?
                ORDER BY created_at DESC
                LIMIT ?
        `, userID, limit)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var logs []map[string]interface{}
        for rows.Next() </span><span class="cov0" title="0">{
                var action, ipAddress, details, createdAt string
                var success bool
                if err := rows.Scan(&amp;action, &amp;ipAddress, &amp;success, &amp;details, &amp;createdAt); err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">log := map[string]interface{}{
                        "action":      action,
                        "ip_address":  ipAddress,
                        "success":     success,
                        "details":     details,
                        "created_at":  createdAt,
                }
                logs = append(logs, log)</span>
        }

        <span class="cov0" title="0">return logs, nil</span>
}

// GenerateUUID 生成UUID
func GenerateUUID() string <span class="cov0" title="0">{
        return strings.Replace(uuid.New().String(), "-", "", -1)
}</span>

// MigrateUserBetaCodes 回填用户的 beta_code 字段
// 从 beta_codes 表的 used_by 字段获取用户邮箱，然后更新到用户表的 beta_code 字段
func (d *Database) MigrateUserBetaCodes() (int, error) <span class="cov0" title="0">{
        // 查询已使用的内测码及其用户邮箱
        rows, err := d.query(`
                SELECT DISTINCT bc.code, bc.used_by
                FROM beta_codes bc
                WHERE bc.used = 1 AND bc.used_by IS NOT NULL AND bc.used_by != ''
        `)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("查询内测码失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        updatedCount := 0
        for rows.Next() </span><span class="cov0" title="0">{
                var code, usedBy string
                if err := rows.Scan(&amp;code, &amp;usedBy); err != nil </span><span class="cov0" title="0">{
                        log.Printf("⚠️ 扫描内测码记录失败: %v", err)
                        continue</span>
                }

                // 更新用户表的 beta_code 字段
                <span class="cov0" title="0">result, err := d.exec(`
                        UPDATE users
                        SET beta_code = ?
                        WHERE email = ? AND beta_code IS NULL
                `, code, usedBy)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("⚠️ 更新用户 %s 的 beta_code 失败: %v", usedBy, err)
                        continue</span>
                }

                <span class="cov0" title="0">rowsAffected, _ := result.RowsAffected()
                if rowsAffected &gt; 0 </span><span class="cov0" title="0">{
                        updatedCount++
                        log.Printf("✅ 已为用户 %s 关联内测码 %s", usedBy, code)
                }</span>
        }

        <span class="cov0" title="0">return updatedCount, nil</span>
}

// GetUserBetaCode 获取用户关联的内测码
func (d *Database) GetUserBetaCode(userID string) (string, error) <span class="cov0" title="0">{
        var betaCode sql.NullString
        err := d.queryRow(`
                SELECT beta_code FROM users WHERE id = $1
        `, userID).Scan(&amp;betaCode)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>
        <span class="cov0" title="0">if !betaCode.Valid </span><span class="cov0" title="0">{
                return "", nil
        }</span>
        <span class="cov0" title="0">return betaCode.String, nil</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">// Package middleware 安全中间件
// 设计哲学：防御式编程，多层保护，性能优先
package middleware

import (
        "fmt"
        "net/http"
        "sync"
        "time"

        "github.com/gin-gonic/gin"
)

// RateLimiter 频率限制器
type RateLimiter struct {
        requests map[string][]time.Time
        mutex    sync.RWMutex
        limit    int
        window   time.Duration
}

// NewRateLimiter 创建频率限制器
func NewRateLimiter(limit int, window time.Duration) *RateLimiter <span class="cov8" title="1">{
        return &amp;RateLimiter{
                requests: make(map[string][]time.Time),
                limit:    limit,
                window:   window,
        }
}</span>

// Allow 检查是否允许请求
func (r *RateLimiter) Allow(key string) bool <span class="cov8" title="1">{
        r.mutex.Lock()
        defer r.mutex.Unlock()

        now := time.Now()
        cutoff := now.Add(-r.window)

        // 清理过期的请求记录
        if requests, exists := r.requests[key]; exists </span><span class="cov8" title="1">{
                validRequests := make([]time.Time, 0)
                for _, reqTime := range requests </span><span class="cov8" title="1">{
                        if reqTime.After(cutoff) </span><span class="cov8" title="1">{
                                validRequests = append(validRequests, reqTime)
                        }</span>
                }
                <span class="cov8" title="1">r.requests[key] = validRequests</span>
        }

        // 检查当前请求数量
        <span class="cov8" title="1">if len(r.requests[key]) &gt;= r.limit </span><span class="cov8" title="1">{
                return false
        }</span>

        // 记录当前请求
        <span class="cov8" title="1">r.requests[key] = append(r.requests[key], now)
        return true</span>
}

// Cleanup 清理过期数据
func (r *RateLimiter) Cleanup() <span class="cov8" title="1">{
        r.mutex.Lock()
        defer r.mutex.Unlock()

        cutoff := time.Now().Add(-r.window)
        for key, requests := range r.requests </span><span class="cov8" title="1">{
                validRequests := make([]time.Time, 0)
                for _, reqTime := range requests </span><span class="cov8" title="1">{
                        if reqTime.After(cutoff) </span><span class="cov8" title="1">{
                                validRequests = append(validRequests, reqTime)
                        }</span>
                }
                <span class="cov8" title="1">if len(validRequests) == 0 </span><span class="cov8" title="1">{
                        delete(r.requests, key)
                }</span> else<span class="cov8" title="1"> {
                        r.requests[key] = validRequests
                }</span>
        }
}

// RateLimitConfig 频率限制配置
type RateLimitConfig struct {
        // 积分操作限制
        CreditOperations RateLimitRule
        // 管理员操作限制
        AdminOperations RateLimitRule
        // 套餐查询限制（公开接口）
        PackageQueries RateLimitRule
}

// RateLimitRule 频率限制规则
type RateLimitRule struct {
        Window   time.Duration
        MaxCount int
}

// DefaultRateLimitConfig 默认频率限制配置
func DefaultRateLimitConfig() *RateLimitConfig <span class="cov8" title="1">{
        return &amp;RateLimitConfig{
                CreditOperations: RateLimitRule{
                        Window:   time.Minute,
                        MaxCount: 10, // 每分钟最多10次积分操作
                },
                AdminOperations: RateLimitRule{
                        Window:   time.Minute,
                        MaxCount: 30, // 管理员每分钟最多30次操作
                },
                PackageQueries: RateLimitRule{
                        Window:   time.Minute,
                        MaxCount: 60, // 公开查询每分钟最多60次
                },
        }
}</span>

// RateLimitMiddleware 频率限制中间件
type RateLimitMiddleware struct {
        limiters map[string]*RateLimiter
        config   *RateLimitConfig
        mutex    sync.RWMutex
}

// NewRateLimitMiddleware 创建频率限制中间件
func NewRateLimitMiddleware(config *RateLimitConfig) *RateLimitMiddleware <span class="cov8" title="1">{
        if config == nil </span><span class="cov0" title="0">{
                config = DefaultRateLimitConfig()
        }</span>

        <span class="cov8" title="1">return &amp;RateLimitMiddleware{
                limiters: make(map[string]*RateLimiter),
                config:   config,
        }</span>
}

// getLimiter 获取指定规则的频率限制器
func (m *RateLimitMiddleware) getLimiter(rule string) *RateLimiter <span class="cov8" title="1">{
        m.mutex.RLock()
        limiter, exists := m.limiters[rule]
        m.mutex.RUnlock()

        if exists </span><span class="cov8" title="1">{
                return limiter
        }</span>

        // 如果不存在，创建新的限制器
        <span class="cov8" title="1">m.mutex.Lock()
        defer m.mutex.Unlock()

        // 双重检查
        if limiter, exists := m.limiters[rule]; exists </span><span class="cov0" title="0">{
                return limiter
        }</span>

        <span class="cov8" title="1">var limit int
        var window time.Duration

        switch rule </span>{
        case "credit_operations":<span class="cov8" title="1">
                limit = m.config.CreditOperations.MaxCount
                window = m.config.CreditOperations.Window</span>
        case "admin_operations":<span class="cov0" title="0">
                limit = m.config.AdminOperations.MaxCount
                window = m.config.AdminOperations.Window</span>
        case "package_queries":<span class="cov8" title="1">
                limit = m.config.PackageQueries.MaxCount
                window = m.config.PackageQueries.Window</span>
        default:<span class="cov0" title="0">
                limit = 100
                window = time.Minute</span>
        }

        <span class="cov8" title="1">limiter = NewRateLimiter(limit, window)
        m.limiters[rule] = limiter
        return limiter</span>
}

// Middleware 创建频率限制中间件
func (m *RateLimitMiddleware) Middleware(rule string) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                // 生成唯一key（基于用户ID或IP地址）
                key := generateRateLimitKey(c, rule)

                // 获取对应的限制器
                limiter := m.getLimiter(rule)

                // 检查是否超过限制
                if !limiter.Allow(key) </span><span class="cov8" title="1">{
                        c.JSON(http.StatusTooManyRequests, gin.H{
                                "error": "请求过于频繁",
                                "message": fmt.Sprintf("请在 %v 后重试", limiter.window),
                        })
                        c.Abort()
                        return
                }</span>

                <span class="cov8" title="1">c.Next()</span>
        }
}

// generateRateLimitKey 生成频率限制key
func generateRateLimitKey(c *gin.Context, rule string) string <span class="cov8" title="1">{
        // 优先使用用户ID
        if userID, exists := c.Get("userID"); exists </span><span class="cov8" title="1">{
                return fmt.Sprintf("%s:%v", rule, userID)
        }</span>

        // 如果没有用户ID，使用IP地址
        <span class="cov8" title="1">ip := c.ClientIP()
        if ip == "" </span><span class="cov8" title="1">{
                ip = c.RemoteIP()
        }</span>

        <span class="cov8" title="1">return fmt.Sprintf("%s:%s", rule, ip)</span>
}

// StartCleanup 启动定期清理任务
func (m *RateLimitMiddleware) StartCleanup(interval time.Duration) <span class="cov0" title="0">{
        ticker := time.NewTicker(interval)
        go func() </span><span class="cov0" title="0">{
                for range ticker.C </span><span class="cov0" title="0">{
                        m.mutex.Lock()
                        for _, limiter := range m.limiters </span><span class="cov0" title="0">{
                                limiter.Cleanup()
                        }</span>
                        <span class="cov0" title="0">m.mutex.Unlock()</span>
                }
        }()
}

// InputValidator 输入验证器
type InputValidator struct{}

// NewInputValidator 创建输入验证器
func NewInputValidator() *InputValidator <span class="cov0" title="0">{
        return &amp;InputValidator{}
}</span>

// ValidateCreditPackage 验证积分套餐输入
func (v *InputValidator) ValidateCreditPackage(req interface{}) error <span class="cov0" title="0">{
        // TODO: 实现具体的验证逻辑
        return nil
}</span>

// ValidateAdjustCredits 验证调整积分输入
func (v *InputValidator) ValidateAdjustCredits(req interface{}) error <span class="cov0" title="0">{
        // TODO: 实现具体的验证逻辑
        return nil
}</span>

// SecurityHeadersMiddleware 安全头中间件
func SecurityHeadersMiddleware() gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                // 设置安全头
                c.Header("X-Content-Type-Options", "nosniff")
                c.Header("X-Frame-Options", "DENY")
                c.Header("X-XSS-Protection", "1; mode=block")
                c.Header("Strict-Transport-Security", "max-age=31536000; includeSubDomains")
                c.Header("Referrer-Policy", "strict-origin-when-cross-origin")

                c.Next()
        }</span>
}

// AuditLogger 审计日志记录器
type AuditLogger struct {
        // TODO: 实现审计日志记录
}

// NewAuditLogger 创建审计日志记录器
func NewAuditLogger() *AuditLogger <span class="cov0" title="0">{
        return &amp;AuditLogger{}
}</span>

// LogAdminAction 记录管理员操作
func (a *AuditLogger) LogAdminAction(userID, action, details string) {<span class="cov0" title="0">
        // TODO: 实现审计日志记录
        // 这里可以记录到数据库或日志文件
}</span>

// LogCreditOperation 记录积分操作
func (a *AuditLogger) LogCreditOperation(userID, operation, details string) {<span class="cov0" title="0">
        // TODO: 实现积分操作日志记录
        // 这里可以记录到数据库或日志文件
}</span>

// RateLimitByUser 基于用户的频率限制
func RateLimitByUser(limit int, window time.Duration) gin.HandlerFunc <span class="cov8" title="1">{
        middleware := NewRateLimitMiddleware(&amp;RateLimitConfig{
                CreditOperations: RateLimitRule{
                        Window:   window,
                        MaxCount: limit,
                },
        })
        return middleware.Middleware("credit_operations")
}</span>

// RateLimitByIP 基于IP的频率限制
func RateLimitByIP(limit int, window time.Duration) gin.HandlerFunc <span class="cov8" title="1">{
        middleware := NewRateLimitMiddleware(&amp;RateLimitConfig{
                PackageQueries: RateLimitRule{
                        Window:   window,
                        MaxCount: limit,
                },
        })
        return middleware.Middleware("package_queries")
}</span>

// RateLimitAdmin 管理员操作频率限制
func RateLimitAdmin(limit int, window time.Duration) gin.HandlerFunc <span class="cov0" title="0">{
        middleware := NewRateLimitMiddleware(&amp;RateLimitConfig{
                AdminOperations: RateLimitRule{
                        Window:   window,
                        MaxCount: limit,
                },
        })
        return middleware.Middleware("admin_operations")
}</span>

// CombinedSecurityMiddleware 组合安全中间件
func CombinedSecurityMiddleware() gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                // 1. 安全头
                SecurityHeadersMiddleware()(c)

                // 2. 基本频率限制（基于IP）
                RateLimitByIP(60, time.Minute)(c)

                // 3. 如果请求被中止，直接返回
                if c.IsAborted() </span><span class="cov0" title="0">{
                        return
                }</span>

                <span class="cov8" title="1">c.Next()</span>
        }
}

// InitSecurityMiddlewares 初始化所有安全中间件
func InitSecurityMiddlewares() <span class="cov0" title="0">{
        // 启动频率限制清理任务
        config := DefaultRateLimitConfig()
        middleware := NewRateLimitMiddleware(config)

        // 每5分钟清理一次过期数据
        middleware.StartCleanup(5 * time.Minute)

        // TODO: 初始化其他安全组件
}</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
