# Monnaire Trading Agent OS 注册失败问题 - 完整修复方案

## 问题分析

### 🔍 根本原因
**两个关键问题导致注册失败**：

1. **数据库Schema不匹配**：
   - `users`表缺少关键字段：`locked_until`, `failed_attempts`, `last_failed_at`, `is_active`, `is_admin`, `beta_code`
   - `CreateUser`函数尝试插入这些字段，导致SQL错误（500错误）

2. **前端API调用错误**：
   - `AuthContext.tsx`使用相对路径`/api/register`
   - 生产环境中向Vercel URL发送请求，而非后端API URL
   - 导致网络层面的"网络错误"提示

## ✅ 已修复的问题

### 1. 后端数据库迁移
**文件**：`/config/database.go`
**修复**：在`alterTables()`函数中添加users表缺失字段的迁移语句

```sql
ALTER TABLE users ADD COLUMN locked_until DATETIME;
ALTER TABLE users ADD COLUMN failed_attempts INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN last_failed_at DATETIME;
ALTER TABLE users ADD COLUMN is_active BOOLEAN DEFAULT 1;
ALTER TABLE users ADD COLUMN is_admin BOOLEAN DEFAULT 0;
ALTER TABLE users ADD COLUMN beta_code TEXT;
```

### 2. 前端API配置修复
**文件**：
- `web/src/contexts/AuthContext.tsx` - 修复所有API调用
- `web/src/lib/config.ts` - 修复系统配置API调用

**修复内容**：添加API_BASE_URL配置
```javascript
const API_BASE = import.meta.env.DEV
  ? '/api'
  : (import.meta.env.VITE_API_URL || 'https://nofx-gyc567.replit.app') + '/api';
```

## 🚀 部署步骤

### 步骤1：更新后端数据库（立即生效）
需要在Replit上执行SQL语句，更新`config.db`文件：

```sql
-- 连接到Replit控制台，运行以下命令：
sqlite3 config.db
ALTER TABLE users ADD COLUMN locked_until DATETIME;
ALTER TABLE users ADD COLUMN failed_attempts INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN last_failed_at DATETIME;
ALTER TABLE users ADD COLUMN is_active BOOLEAN DEFAULT 1;
ALTER TABLE users ADD COLUMN is_admin BOOLEAN DEFAULT 0;
ALTER TABLE users ADD COLUMN beta_code TEXT;
.quit
```

### 步骤2：重新部署前端（修复网络问题）
前端代码已修复，需要重新部署：

1. **方案A：使用GitHub Actions**
   - 推送修复后的代码到GitHub
   - 自动触发Vercel部署

2. **方案B：手动部署**
   ```bash
   cd web
   npm run build
   npm run deploy
   ```

3. **方案C：设置环境变量**
   在Vercel项目中设置环境变量：
   - 变量名：`VITE_API_URL`
   - 变量值：`https://nofx-gyc567.replit.app`

## 🧪 验证修复

### 测试1：数据库迁移
```bash
sqlite3 config.db ".schema users"
```
应该看到包含所有字段的完整表结构。

### 测试2：后端API
```bash
curl -X POST https://nofx-gyc567.replit.app/api/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```
期望响应：成功注册或"邮箱已被注册"错误（不再是500错误）

### 测试3：前端注册
访问：https://web-pink-omega-40.vercel.app/register
尝试注册新用户，应该看到成功或正确的错误提示，而非"网络错误"

## 📝 技术要点

### 为什么会出现这个问题？
1. **代码演进**：User结构体和数据库表定义不同步
   - 代码更新添加了新字段，但数据库表结构未更新
   - 缺少了数据库迁移的自动化检查

2. **部署环境差异**：
   - 开发环境：前后端在同一服务，相对路径工作正常
   - 生产环境：前后端分离，需要使用绝对URL

### 最佳实践
1. **数据库迁移**：确保代码和数据库schema始终同步
2. **环境配置**：区分开发和生产环境的API配置
3. **错误处理**：区分网络错误和业务逻辑错误

## 📞 后续支持

如果问题仍然存在：
1. 检查Replit上的数据库是否已更新
2. 检查Vercel部署是否使用了最新的前端代码
3. 查看浏览器控制台的网络请求，确认API调用地址是否正确

---
**修复完成时间**：2025-11-14
**涉及文件**：
- `/config/database.go`
- `/web/src/contexts/AuthContext.tsx`
- `/web/src/lib/config.ts`
